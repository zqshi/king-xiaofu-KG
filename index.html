<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM风格智能助手</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1677FF', // 调整为更专业的蓝色
                        secondary: '#0969DA',
                        success: '#10B981',
                        warning: '#F59E0B',
                        error: '#EF4444',
                        'bg-light': '#F9FAFB', // 更柔和的背景色
                        'bg-dark': '#1F2937',
                        'text-primary': '#111827', // 更深的主文本色
                        'text-secondary': '#6B7280', // 更柔和的次要文本色
                        'border-light': '#E5E7EB',
                        'border-dark': '#374151',
                    },
                    fontFamily: {
                        sans: ['Inter', 'SF Pro Display', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
                        'dropdown': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'elevated': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    },
                    spacing: {
                        '88': '22rem',
                    },
                    transitionProperty: {
                        'height': 'height',
                        'spacing': 'margin, padding',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 2px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #a1a1a1;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .message-bubble-user {
                @apply bg-primary text-white rounded-t-lg rounded-bl-lg rounded-tr-lg shadow-sm transition-all duration-200 hover:shadow-md;
            }
            .message-bubble-system {
                @apply bg-white text-text-primary rounded-t-lg rounded-br-lg rounded-tl-lg border border-border-light shadow-sm transition-all duration-200 hover:shadow-md;
            }
            .message-bubble-admin {
                @apply bg-blue-50 text-primary rounded-t-lg rounded-br-lg rounded-tl-lg border border-blue-100 shadow-sm transition-all duration-200 hover:shadow-md;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 active:bg-secondary;
            }
            .btn-secondary {
                @apply bg-white text-text-primary px-4 py-2 rounded-lg border border-border-light hover:bg-gray-50 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50;
            }
            .input-primary {
                @apply w-full px-4 py-2 rounded-lg border border-border-light focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200;
            }
            .card-hover {
                @apply transition-all duration-200 hover:shadow-md hover:-translate-y-0.5;
            }
            .slide-in {
                animation: slideIn 0.3s ease forwards;
            }
            .slide-out {
                animation: slideOut 0.3s ease forwards;
            }
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            /* 上传区域滑入滑出动画 */
            .animate-slide-down {
                animation: slideDown 0.3s ease forwards;
            }
            .animate-slide-up {
                animation: slideUp 0.3s ease forwards;
            }
            @keyframes slideDown {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(20px); opacity: 0; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.3s ease forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .pulse {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(0.95); opacity: 0.7; }
                50% { transform: scale(1); opacity: 1; }
                100% { transform: scale(0.95); opacity: 0.7; }
            }
            .typing-indicator {
                display: inline-flex;
                align-items: center;
            }
            .typing-indicator span {
                height: 8px;
                width: 8px;
                margin: 0 1px;
                background-color: #888;
                border-radius: 50%;
                display: inline-block;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) {
                animation-delay: -0.32s;
            }
            .typing-indicator span:nth-child(2) {
                animation-delay: -0.16s;
            }
            @keyframes typing {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }

            /* 知识树节点样式 */
            .tree-node-item {
                @apply flex items-center text-sm transition-colors duration-150;
            }
            .tree-node-item:hover {
                @apply bg-gray-100;
            }
            .tree-node-item.active {
                @apply bg-teal-50 text-teal-600 font-medium;
            }
            .tree-toggle {
                @apply transition-transform duration-150 cursor-pointer;
            }
            .tree-toggle.expanded {
                transform: rotate(90deg);
            }
            .tree-children {
                @apply pl-4 space-y-1;
            }
        }
    </style>
</head>

<body class="bg-bg-light font-sans text-text-primary h-screen flex overflow-hidden antialiased">
    <!-- 左侧栏 -->
    <div class="w-[320px] bg-white border-r border-gray-200 flex flex-col h-full">
        <!-- 顶部标题 -->
        <div class="p-4 border-b border-border-light flex items-center bg-white shadow-sm">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3 overflow-hidden">
                <img src="https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/bc78a698ed6144caafa7ca5919f41fb0~tplv-a9rns2rl98-image.image?rcl=202512081555431B42F5AF6D301FF2AF76&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1767772585&x-signature=BwnPS1QxO8PKVSCjRs0hcXB%2FBsc%3D"
                     alt="HRssc Logo"
                     class="w-full h-full object-cover rounded-lg"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-full h-full bg-teal-100 flex items-center justify-center rounded-lg" style="display:none;">
                    <i class="fa fa-book text-teal-600 text-xl"></i>
                </div>
            </div>
            <h1 class="text-lg font-semibold text-text-primary">HRssc知识管理</h1>
        </div>

        <!-- 搜索框 -->
        <div class="p-4">
            <div class="relative">
                <input type="text" placeholder="搜索指令..." class="input-primary pl-10">
                <i class="fa fa-search absolute left-3 top-3 text-text-secondary"></i>
            </div>
        </div>





        <!-- 指令列表 -->
        <div class="flex-1 overflow-y-auto scrollbar-hide px-4">
            <h2 class="text-sm font-medium text-text-secondary uppercase tracking-wider mb-2">快捷指令</h2>
            <div class="space-y-3">
                <!-- 指令卡片 1 -->
                <div
                    class="command-card p-3 rounded-lg border border-border-light hover:border-primary hover:shadow-sm cursor-pointer transition-all card-hover">
                    <div class="flex items-start">
                        <div class="bg-blue-50 text-primary p-2 rounded-lg mr-3">
                            <i class="fa fa-file-text-o"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-text-primary">总结文档</h3>
                            <p class="text-sm text-text-secondary mt-1">快捷生成文档摘要</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：今天</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 2 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-green-100 text-green-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-bar-chart"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">数据分析</h3>
                            <p class="text-sm text-text-secondary mt-1">提取表格数据并分析</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：昨天</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 3 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-purple-100 text-purple-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-comments-o"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">智能问答</h3>
                            <p class="text-sm text-text-secondary mt-1">基于知识库回答问题</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：3天前</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 3.5 知识统计 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-bar-chart"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">知识统计</h3>
                            <p class="text-sm text-text-secondary mt-1">快速查看知识与工单概览</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：刚刚</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 3.6 知识管理 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-teal-100 text-teal-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-database"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">知识管理</h3>
                            <p class="text-sm text-text-secondary mt-1">文档库与FAQ库管理</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：今天</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 3.7 异常处理 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-orange-100 text-orange-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-exclamation-triangle"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">异常处理</h3>
                            <p class="text-sm text-text-secondary mt-1">快速查看并批量处理异常</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：刚刚</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 指令卡片 5 -->
                <div
                    class="command-card p-3 rounded-lg border border-gray-200 hover:border-primary hover:shadow-sm cursor-pointer transition-all">
                    <div class="flex items-start">
                        <div class="bg-red-100 text-red-600 p-2 rounded-lg mr-3">
                            <i class="fa fa-file-pdf-o"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">PDF转换</h3>
                            <p class="text-sm text-text-secondary mt-1">PDF文件格式转换</p>
                            <div class="flex items-center mt-2 text-xs text-text-secondary">
                                <i class="fa fa-clock-o mr-1"></i>
                                <span>最近使用：2周前</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部状态指示器 -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center">
                <div class="w-2 h-2 bg-success rounded-full mr-2"></div>
                <span class="text-sm text-text-secondary">Agent 在线</span>
            </div>
        </div>
    </div>

    <!-- 统计面板遮罩 -->
    <div id="stats-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"></div>

    <!-- 统计主面板遮罩（与知识/异常面板保持一致） -->
    <div id="stats-main-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"></div>

    <!-- 右侧统计滑出面板 -->
    <div id="stats-panel"
        class="fixed top-0 right-0 h-full w-full sm:w-[520px] bg-white shadow-elevated transform translate-x-full transition-transform duration-300 z-40 flex flex-col">
        <div class="flex items-center justify-between px-4 py-3 border-b border-border-light">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-primary bg-opacity-10 flex items-center justify-center">
                    <i class="fa fa-bar-chart text-primary text-lg"></i>
                </div>
                <div>
                    <p class="text-sm text-text-secondary">统计分析</p>
                    <p class="text-base font-semibold text-text-primary">知识与工单概览</p>
                </div>
            </div>
            <button id="stats-close" class="text-text-secondary hover:text-primary">
                <i class="fa fa-times text-lg"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-bg-light">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">文档冲突</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">12</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fa fa-exclamation-triangle text-red-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-red-500">
                        <i class="fa fa-arrow-up"></i>
                        <span>较上周 +8%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">待分类文档</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">28</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fa fa-folder-o text-yellow-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-yellow-500">
                        <i class="fa fa-arrow-up"></i>
                        <span>较上周 +12%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">FAQ 待审</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">18</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-question-circle-o text-blue-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-green-500">
                        <i class="fa fa-arrow-down"></i>
                        <span>环比 -5%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">待回复工单</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">7</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fa fa-comment-o text-green-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-green-500">
                        <i class="fa fa-arrow-down"></i>
                        <span>环比 -15%</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-card p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">待办趋势图</h3>
                    <div class="flex items-center space-x-2">
                        <button class="px-3 py-1 text-xs font-medium rounded-md bg-primary text-white">7天</button>
                        <button class="px-3 py-1 text-xs font-medium rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200">30天</button>
                        <button class="px-3 py-1 text-xs font-medium rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200">90天</button>
                    </div>
                </div>
                <div class="h-64 bg-gradient-to-br from-blue-50 to-white rounded-lg flex items-center justify-center relative overflow-hidden">
                    <div class="absolute inset-0 opacity-60" style="background-image: linear-gradient(to right, rgba(22,119,255,0.1) 0%, rgba(22,119,255,0.05) 50%, rgba(22,119,255,0) 100%);"></div>
                    <div class="w-full px-4">
                        <div class="grid grid-cols-12 gap-1 items-end h-48">
                            <div class="bg-primary bg-opacity-60 rounded-t h-12"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-16"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-20"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-10"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-24"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-32"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-28"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-20"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-18"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-24"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-30"></div>
                            <div class="bg-primary bg-opacity-60 rounded-t h-26"></div>
                        </div>
                        <p class="text-center text-xs text-text-secondary mt-3">最近 12 周趋势（模拟数据）</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理面板遮罩 -->
    <div id="mgmt-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"></div>

    <!-- 处理面板遮罩 -->
    <div id="detail-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40"></div>

    <!-- 处理面板 -->
    <div id="detail-panel"
        class="fixed top-0 right-0 h-full w-[600px] bg-white shadow-elevated transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <!-- 顶部控制栏 -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-border-light sticky top-0 bg-white z-10">
            <div class="flex items-center space-x-2">
                <i id="detail-icon" class="fa fa-exclamation-circle text-warning text-lg"></i>
                <span class="font-semibold text-text-primary" id="detail-title">处理详情</span>
            </div>
            <button id="detail-close" class="text-text-secondary hover:text-primary transition-colors">
                <i class="fa fa-times text-lg"></i>
            </button>
        </div>

        <!-- 内容区域（动态加载） -->
        <div id="detail-content" class="flex-1 overflow-y-auto p-4 bg-bg-light"></div>
    </div>

    <!-- 批量处理对话框遮罩 -->
    <div id="batch-dialog-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"></div>

    <!-- 批量处理对话框 -->
    <div id="batch-dialog" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl w-full max-w-md hidden z-50">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-text-primary mb-4" id="batch-dialog-title">批量处理</h3>
            <div id="batch-dialog-content" class="mb-6">
                <!-- 动态内容 -->
            </div>
            <div class="flex justify-end space-x-3">
                <button class="btn-secondary" id="batch-dialog-cancel">取消</button>
                <button class="btn-primary" id="batch-dialog-confirm">确认</button>
            </div>
        </div>
    </div>

    <!-- 异常列表面板遮罩 -->
    <div id="exception-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"></div>

    <!-- 异常列表面板 (表格管理风格 - 橙色系) -->
    <div id="exception-panel"
        class="fixed top-0 right-0 h-full w-[720px] bg-white shadow-elevated transform translate-x-full transition-transform duration-300 z-40 flex flex-col">
        <!-- 左侧拖拽手柄 -->
        <div id="exception-resize-handle" class="absolute left-0 top-0 h-full w-1 bg-gray-300 hover:bg-orange-500 cursor-col-resize transition-colors z-50"></div>

        <!-- 顶部控制栏 -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-orange-100 sticky top-0 bg-gradient-to-r from-orange-50 to-white z-10">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                    <i class="fa fa-exclamation-triangle text-orange-600 text-lg"></i>
                </div>
                <div>
                    <p class="text-sm text-orange-600">异常管理</p>
                    <p class="text-base font-semibold text-text-primary">统一处理异常知识</p>
                </div>
            </div>
            <button id="exception-close" class="text-text-secondary hover:text-orange-600 transition-colors">
                <i class="fa fa-times text-lg"></i>
            </button>
        </div>

        <!-- 内容区域 -->
        <div id="exception-panel-body" class="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-orange-50/20 to-white">
            <div id="exception-list-view">
                <!-- 筛选器 -->
                <div class="bg-white rounded-lg shadow-card p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">类型筛选</label>
                            <select class="input-primary" id="exception-type-filter">
                                <option value="all">全部</option>
                                <option value="conflict">文档冲突</option>
                                <option value="category">待分类</option>
                                <option value="faq">FAQ待审</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">状态筛选</label>
                            <select class="input-primary" id="exception-status-filter">
                                <option value="all">全部</option>
                                <option value="pending">待处理</option>
                                <option value="in_progress">处理中</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">搜索</label>
                            <input type="text" class="input-primary" placeholder="关键词搜索..." id="exception-search">
                        </div>
                    </div>
                </div>

                <!-- 批量操作工具栏 -->
                <div class="bg-white rounded-lg shadow-card p-3 mb-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="exception-select-all" class="w-4 h-4">
                        <span class="text-sm text-text-secondary">已选择 <span id="exception-selected-count">0</span> 项</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="btn-primary text-sm px-3 py-1.5" id="exception-batch-handle">
                            <i class="fa fa-check mr-1"></i> 批量处理
                        </button>
                        <button class="btn-secondary text-sm px-3 py-1.5" id="exception-batch-ignore">
                            <i class="fa fa-times mr-1"></i> 批量忽略
                        </button>
                    </div>
                </div>

                <!-- 异常列表 -->
                <div class="bg-white rounded-lg shadow-card overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-border-light">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase w-12"></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase">知识点描述</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase w-24">类型</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase w-32">检测时间</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase w-20">优先级</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase w-32">操作</th>
                            </tr>
                        </thead>
                        <tbody id="exception-list" class="divide-y divide-border-light">
                            <!-- 动态生成异常列表 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 异常详情视图（面板内切换，不离开列表） -->
            <div id="exception-detail-view" class="hidden space-y-4">
                <div class="bg-white rounded-lg shadow-card p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button id="exception-back-btn" class="btn-secondary text-sm px-3 py-1.5">
                            <i class="fa fa-arrow-left mr-1"></i> 返回列表
                        </button>
                        <div>
                            <p id="exception-detail-type" class="text-xs text-orange-600">异常详情</p>
                            <p id="exception-detail-title" class="text-base font-semibold text-text-primary">知识点标题</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span id="exception-detail-priority" class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">高</span>
                        <p id="exception-detail-time" class="text-xs text-text-secondary mt-1"></p>
                    </div>
                </div>
                <div id="exception-detail-content" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- 知识管理遮罩 -->
    <div id="knowledge-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-30"></div>

    <!-- 知识管理面板 (侧边栏模式 - 绿色系) -->
    <div id="knowledge-panel"
        class="fixed top-0 right-0 h-full w-[800px] bg-white shadow-elevated transform translate-x-full transition-transform duration-300 z-40 flex flex-col">
        <!-- 左侧拖拽手柄 -->
        <div id="panel-resize-handle" class="absolute left-0 top-0 h-full w-1 bg-gray-300 hover:bg-teal-500 cursor-col-resize transition-colors z-50"></div>

        <!-- 顶部控制栏 -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-teal-100 sticky top-0 bg-gradient-to-r from-teal-50 to-white z-10">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 rounded-lg bg-teal-100 flex items-center justify-center">
                        <i class="fa fa-database text-teal-600 text-lg"></i>
                    </div>
                    <div>
                        <p class="text-sm text-teal-600">知识管理</p>
                        <p class="text-base font-semibold text-text-primary">知识库管理系统</p>
                    </div>
                </div>
                <!-- 顶部库类型切换标签 -->
                <div class="flex border-b-0 ml-8">
                    <button id="tab-doc-library" class="library-tab px-4 py-2 text-sm font-medium border-b-2 border-teal-600 text-teal-600 bg-teal-50 rounded-t-lg">
                        <i class="fa fa-file-text mr-1"></i>文档库
                    </button>
                    <button id="tab-faq-library" class="library-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-text-secondary hover:text-teal-600 rounded-t-lg ml-1">
                        <i class="fa fa-question-circle mr-1"></i>FAQ库
                    </button>
                </div>
            </div>
            <button id="knowledge-close" class="text-text-secondary hover:text-teal-600 transition-colors">
                <i class="fa fa-times text-lg"></i>
            </button>
        </div>

        <!-- 文档库内容区 -->
        <div id="doc-library-content" class="flex flex-1 overflow-hidden">
            <!-- 左侧：知识体系树 -->
            <div id="knowledge-tree-side" class="w-64 border-r border-gray-200 flex flex-col bg-gray-50">
                <!-- 树标题和操作按钮 -->
                <div class="px-4 py-3 border-b border-gray-200 bg-white">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa fa-sitemap mr-2 text-teal-600"></i>
                            知识体系
                        </h3>
                        <button id="add-category-btn" class="text-teal-600 hover:text-teal-700 text-sm" title="添加分类">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                </div>

                <!-- 树搜索 -->
                <div class="px-4 py-3 border-b border-gray-200 bg-white">
                    <div class="relative">
                        <input type="text" id="tree-search" placeholder="搜索分类..."
                               class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <i class="fa fa-search absolute left-2.5 top-2.5 text-gray-400"></i>
                    </div>
                </div>

                <!-- 树节点列表 -->
                <div id="knowledge-tree-nodes" class="flex-1 overflow-y-auto p-2">
                    <div class="text-sm text-gray-500 px-3 py-2">正在加载知识分类体系...</div>
                </div>
            </div>

            <!-- 可拖动分隔条 -->
            <div id="knowledge-divider" class="w-1 bg-gray-200 hover:bg-teal-500 cursor-col-resize transition-colors"></div>

            <!-- 右侧：文档内容区 -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- 面包屑 -->
                <div class="px-5 py-3 border-b border-gray-100 bg-white">
                    <div id="knowledge-breadcrumb" class="flex items-center text-sm text-gray-500">
                        <i class="fa fa-home mr-1"></i>
                        <span id="breadcrumb-text">全部知识</span>
                    </div>
                </div>

                <!-- 文档列表区域 -->
                <div class="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-teal-50/20 to-white">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">文档列表</h3>
                    <button id="add-document-btn" class="px-3 py-1.5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 text-sm">
                        <i class="fa fa-plus mr-1"></i>添加文档
                    </button>
                </div>
                <div id="node-meta-panel" class="grid md:grid-cols-2 gap-3 mb-4"></div>
                <div id="documents-list" class="space-y-3">
                    <!-- 文档列表将通过JavaScript动态生成 -->
                    <div class="text-center text-text-secondary py-8">
                        <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                        <p>请从左侧选择知识分类查看文档</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ库内容区 -->
        <div id="faq-library-content" class="flex-1 flex-col overflow-hidden hidden">
            <!-- FAQ顶部操作栏 -->
            <div class="px-5 py-4 border-b border-gray-100 bg-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">FAQ列表</h3>
                        <p class="text-sm text-gray-500 mt-1">FAQ库统一管理，不区分知识体系</p>
                    </div>
                    <button id="add-faq-btn" class="px-3 py-1.5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 text-sm">
                        <i class="fa fa-plus mr-1"></i>添加FAQ
                    </button>
                </div>
            </div>

            <!-- FAQ列表区域 -->
            <div class="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-teal-50/20 to-white">
                <div id="faq-list" class="space-y-3">
                    <!-- FAQ列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- 文档上传弹窗 -->
    <div id="add-document-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4">
            <!-- 标题栏 -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-text-primary">添加文档</h3>
                <button id="close-document-modal" class="text-text-secondary hover:text-text-primary">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>

            <!-- 内容区域 -->
            <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                <!-- 选择知识体系 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-text-primary mb-2">
                        选择知识分类 <span class="text-red-500">*</span>
                    </label>
                    <select id="doc-category-select" class="input-primary">
                        <option value="">请选择...</option>
                        <!-- 动态生成分类选项 -->
                    </select>
                </div>

                <!-- 文件上传区域 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-text-primary mb-2">
                        上传文档 <span class="text-red-500">*</span>
                    </label>
                    <div id="file-drop-zone"
                         class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-teal-500 transition-colors cursor-pointer">
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
                        <p class="text-text-secondary mb-2">拖拽文件到此处,或点击选择文件</p>
                        <p class="text-xs text-text-secondary">支持 PDF、Word、Excel、PPT 等格式</p>
                        <input type="file" id="modal-file-input" class="hidden" multiple
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt">
                    </div>

                    <!-- 文件列表 -->
                    <div id="modal-file-list" class="mt-4 space-y-2">
                        <!-- 动态生成文件卡片 -->
                    </div>
                </div>

                <!-- 知识加工维度 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-text-primary mb-3">
                        知识加工维度
                    </label>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="process-summary" class="w-4 h-4 text-teal-600 rounded" checked>
                            <span class="ml-2 text-sm">摘要生成</span>
                            <span class="ml-2 text-xs text-gray-500">自动生成文档摘要</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="process-tags" class="w-4 h-4 text-teal-600 rounded" checked>
                            <span class="ml-2 text-sm">标签映射</span>
                            <span class="ml-2 text-xs text-gray-500">自动提取文档关键词标签</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="process-faq" class="w-4 h-4 text-teal-600 rounded">
                            <span class="ml-2 text-sm">FAQ挖掘</span>
                            <span class="ml-2 text-xs text-gray-500">从文档中提取常见问答</span>
                        </label>
                    </div>
                </div>

                <!-- FAQ泛化选项（默认隐藏） -->
                <div id="faq-generalization-options" class="hidden mb-6 ml-6 p-4 bg-teal-50 rounded-lg border border-teal-200">
                    <label class="flex items-center cursor-pointer mb-3">
                        <input type="checkbox" id="enable-faq-generalization" class="w-4 h-4 text-teal-600 rounded">
                        <span class="ml-2 text-sm font-medium">启用FAQ相似问泛化</span>
                        <span class="ml-2 text-xs text-gray-500">为每个FAQ生成多个相似问法</span>
                    </label>

                    <!-- 泛化数量设置（默认隐藏） -->
                    <div id="faq-gen-count-setting" class="hidden">
                        <label class="block text-sm font-medium text-text-primary mb-2">
                            泛化问题数量
                        </label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="faq-gen-count-slider"
                                   min="1" max="10" value="3"
                                   class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="faq-gen-count-value" class="text-lg font-semibold text-teal-600 w-12 text-center">3</span>
                            <span class="text-sm text-gray-500">个</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            为每个FAQ生成 <span class="font-medium text-teal-600" id="faq-gen-count-text">3</span> 个相似问法
                        </p>
                    </div>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button id="cancel-document-btn" class="btn-secondary">取消</button>
                <button id="confirm-document-btn" class="btn-primary">
                    <i class="fa fa-check mr-1"></i>开始处理
                </button>
            </div>
        </div>
    </div>

    <!-- 统计面板 (Dashboard风格 - 蓝色系) -->
    <div id="stats-panel-main"
        class="fixed top-0 right-0 h-full w-full sm:w-[720px] bg-white shadow-elevated transform translate-x-full transition-transform duration-300 z-40 overflow-y-auto">
        <!-- 左侧拖拽手柄 -->
        <div id="stats-resize-handle" class="absolute left-0 top-0 h-full w-1 bg-gray-300 hover:bg-blue-500 cursor-col-resize transition-colors z-50"></div>
        <div class="flex items-center justify-between px-5 py-4 border-b border-blue-100 sticky top-0 bg-gradient-to-r from-blue-50 to-white z-10">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-primary bg-opacity-10 flex items-center justify-center">
                    <i class="fa fa-bar-chart text-primary text-lg"></i>
                </div>
                <div>
                    <p class="text-sm text-blue-600">统计分析</p>
                    <p class="text-base font-semibold text-text-primary">知识库数据概览</p>
                </div>
            </div>
            <button id="stats-main-close" class="text-text-secondary hover:text-primary">
                <i class="fa fa-times text-lg"></i>
            </button>
        </div>

        <div class="p-4 bg-gradient-to-b from-blue-50/30 to-white space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">文档冲突</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">12</p>
                            <p class="text-xs text-text-secondary mt-1">新增 3 条 • 高优先级</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fa fa-exclamation-triangle text-red-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-red-500">
                        <i class="fa fa-arrow-up"></i>
                        <span>较上周 +8%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">待分类文档</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">28</p>
                            <p class="text-xs text-text-secondary mt-1">自动分类命中率 76%</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fa fa-folder-o text-yellow-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-yellow-500">
                        <i class="fa fa-arrow-up"></i>
                        <span>较上周 +12%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">FAQ 待审</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">18</p>
                            <p class="text-xs text-text-secondary mt-1">SLA：需在 24h 内审核</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fa fa-question-circle-o text-blue-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-green-500">
                        <i class="fa fa-arrow-down"></i>
                        <span>环比 -5%</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">待回复工单</p>
                            <p class="text-3xl font-bold text-gray-800 mt-1">7</p>
                            <p class="text-xs text-text-secondary mt-1">平均等待 14 分钟</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fa fa-comment-o text-green-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center space-x-2 text-sm text-green-500">
                        <i class="fa fa-arrow-down"></i>
                        <span>环比 -15%</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">知识利用率</h3>
                        <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-primary">近30天</span>
                    </div>
                    <div class="flex items-center">
                        <div class="relative w-24 h-24 mr-4">
                            <div class="absolute inset-0 rounded-full" style="background: conic-gradient(#1677FF 0% 82%, #E5E7EB 82% 100%);"></div>
                            <div class="absolute inset-2 bg-white rounded-full flex flex-col items-center justify-center">
                                <span class="text-lg font-semibold text-primary">82%</span>
                                <span class="text-xs text-text-secondary">总体</span>
                            </div>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <div class="flex items-center justify-between text-sm font-medium">
                                    <span>文档引用率</span>
                                    <span class="text-text-secondary">68%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                    <div class="h-2 bg-primary rounded-full" style="width: 68%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between text-sm font-medium">
                                    <span>FAQ 命中率</span>
                                    <span class="text-text-secondary">76%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                    <div class="h-2 bg-green-500 rounded-full" style="width: 76%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between text-sm font-medium">
                                    <span>自助解决占比</span>
                                    <span class="text-text-secondary">54%</span>
                                </div>
                                <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                    <div class="h-2 bg-amber-400 rounded-full" style="width: 54%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-text-secondary mt-3">昨日自助解决 124 次，节省人工 18.6 小时</p>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">知识缺口统计</h3>
                        <span class="text-xs text-text-secondary">缺口合计 42 条</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-red-400 mr-2"></span>
                                    社保政策更新
                                </span>
                                <span class="text-text-secondary">12 条</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                <div class="h-2 rounded-full bg-red-400" style="width: 78%;"></div>
                            </div>
                            <p class="text-xs text-text-secondary mt-1">缺少最新报销流程与示例</p>
                        </div>
                        <div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-amber-400 mr-2"></span>
                                    假勤制度
                                </span>
                                <span class="text-text-secondary">9 条</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                <div class="h-2 rounded-full bg-amber-400" style="width: 62%;"></div>
                            </div>
                            <p class="text-xs text-text-secondary mt-1">待补充请假场景与操作指引</p>
                        </div>
                        <div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-blue-400 mr-2"></span>
                                    培训体系
                                </span>
                                <span class="text-text-secondary">6 条</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                <div class="h-2 rounded-full bg-blue-400" style="width: 48%;"></div>
                            </div>
                            <p class="text-xs text-text-secondary mt-1">缺少课程 QA 与讲师联系入口</p>
                        </div>
                        <div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="flex items-center">
                                    <span class="w-2 h-2 rounded-full bg-teal-400 mr-2"></span>
                                    福利申领
                                </span>
                                <span class="text-text-secondary">5 条</span>
                            </div>
                            <div class="w-full h-2 bg-gray-100 rounded-full mt-1">
                                <div class="h-2 rounded-full bg-teal-400" style="width: 40%;"></div>
                            </div>
                            <p class="text-xs text-text-secondary mt-1">待补齐申领路径和表单模板</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">高质量支持 TOP5</h3>
                        <span class="text-xs text-text-secondary">按 CSAT & 解决时长</span>
                    </div>
                    <ul class="divide-y divide-border-light">
                        <li class="py-2 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-text-primary">入职手续指引</p>
                                <p class="text-xs text-text-secondary">满意度 4.9 • 平均 6 分钟</p>
                            </div>
                            <span class="px-2 py-1 rounded-full bg-green-50 text-green-600 text-xs font-medium">CSAT 97%</span>
                        </li>
                        <li class="py-2 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-text-primary">年假计算</p>
                                <p class="text-xs text-text-secondary">满意度 4.8 • 平均 4 分钟</p>
                            </div>
                            <span class="px-2 py-1 rounded-full bg-green-50 text-green-600 text-xs font-medium">CSAT 95%</span>
                        </li>
                        <li class="py-2 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-text-primary">社保基数调整</p>
                                <p class="text-xs text-text-secondary">满意度 4.7 • 平均 5 分钟</p>
                            </div>
                            <span class="px-2 py-1 rounded-full bg-green-50 text-green-600 text-xs font-medium">CSAT 94%</span>
                        </li>
                        <li class="py-2 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-text-primary">培训报名</p>
                                <p class="text-xs text-text-secondary">满意度 4.7 • 平均 8 分钟</p>
                            </div>
                            <span class="px-2 py-1 rounded-full bg-green-50 text-green-600 text-xs font-medium">CSAT 93%</span>
                        </li>
                        <li class="py-2 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-text-primary">福利兑换</p>
                                <p class="text-xs text-text-secondary">满意度 4.6 • 平均 7 分钟</p>
                            </div>
                            <span class="px-2 py-1 rounded-full bg-green-50 text-green-600 text-xs font-medium">CSAT 92%</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg shadow-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">待办趋势图</h3>
                        <div class="flex items-center space-x-2">
                            <button class="px-3 py-1 text-xs font-medium rounded-md bg-primary text-white">7天</button>
                            <button class="px-3 py-1 text-xs font-medium rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200">30天</button>
                            <button class="px-3 py-1 text-xs font-medium rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200">90天</button>
                        </div>
                    </div>
                    <div class="h-64 bg-gradient-to-br from-blue-50 to-white rounded-lg flex items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-60" style="background-image: linear-gradient(to right, rgba(22,119,255,0.1) 0%, rgba(22,119,255,0.05) 50%, rgba(22,119,255,0) 100%);"></div>
                        <div class="w-full px-4">
                            <div class="grid grid-cols-12 gap-1 items-end h-48">
                                <div class="bg-primary bg-opacity-60 rounded-t h-12"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-16"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-20"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-10"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-24"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-32"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-28"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-20"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-18"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-24"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-30"></div>
                                <div class="bg-primary bg-opacity-60 rounded-t h-26"></div>
                            </div>
                            <p class="text-center text-xs text-text-secondary mt-3">最近 12 周趋势（模拟数据）</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">高频问题 TOP5</h3>
                        <span class="text-xs text-text-secondary">近7天</span>
                    </div>
                    <ul class="space-y-2">
                        <li class="flex items-center justify-between bg-blue-50 rounded-lg px-3 py-2">
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full bg-primary text-white text-xs flex items-center justify-center font-semibold">1</span>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">医保报销怎么走</p>
                                    <p class="text-xs text-text-secondary">命中 FAQ 86 次</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600">+14%</span>
                        </li>
                        <li class="flex items-center justify-between px-3 py-2 rounded-lg border border-gray-100">
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full bg-gray-100 text-text-primary text-xs flex items-center justify-center font-semibold">2</span>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">报销失败如何补充材料</p>
                                    <p class="text-xs text-text-secondary">命中 FAQ 64 次</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600">+8%</span>
                        </li>
                        <li class="flex items-center justify-between px-3 py-2 rounded-lg border border-gray-100">
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full bg-gray-100 text-text-primary text-xs flex items-center justify-center font-semibold">3</span>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">年假如何折算</p>
                                    <p class="text-xs text-text-secondary">命中 FAQ 52 次</p>
                                </div>
                            </div>
                            <span class="text-xs text-amber-500">+3%</span>
                        </li>
                        <li class="flex items-center justify-between px-3 py-2 rounded-lg border border-gray-100">
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full bg-gray-100 text-text-primary text-xs flex items-center justify-center font-semibold">4</span>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">社保基数怎么调整</p>
                                    <p class="text-xs text-text-secondary">命中 FAQ 41 次</p>
                                </div>
                            </div>
                            <span class="text-xs text-red-500">-6%</span>
                        </li>
                        <li class="flex items-center justify-between px-3 py-2 rounded-lg border border-gray-100">
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full bg-gray-100 text-text-primary text-xs flex items-center justify-center font-semibold">5</span>
                                <div>
                                    <p class="text-sm font-medium text-text-primary">培训报名入口</p>
                                    <p class="text-xs text-text-secondary">命中 FAQ 33 次</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600">+11%</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧主区域 -->
    <div class="flex-1 flex flex-col h-full bg-bg-light overflow-hidden">
        <!-- 顶部标题栏 -->
        <div class="bg-white border-b border-border-light p-4 flex items-center justify-between shadow-sm">
            <div class="flex items-center">
                <h2 class="text-lg font-semibold text-text-primary">对话</h2>
                <span class="ml-3 px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full flex items-center">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1"></span>
                    在线
                </span>
            </div>
            <div class="flex items-center space-x-2">
                <button
                    class="p-2 rounded-full hover:bg-gray-100 transition-colors text-text-secondary hover:text-primary">
                    <i class="fa fa-history"></i>
                </button>
                <button
                    class="p-2 rounded-full hover:bg-gray-100 transition-colors text-text-secondary hover:text-primary">
                    <i class="fa fa-search"></i>
                </button>
                <button
                    class="p-2 rounded-full hover:bg-gray-100 transition-colors text-text-secondary hover:text-primary">
                    <i class="fa fa-cog"></i>
                </button>
                <div class="flex items-center ml-2">
                    <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center">
                        <span>管</span>
                    </div>
                    <span class="ml-2 text-sm font-medium">管理员</span>
                </div>
            </div>
        </div>

        <!-- 对话显示区 -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 relative">
            <!-- 空状态 -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-full">
                <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/67eb59dbd0544c4789867a135cfcdbdd~tplv-a9rns2rl98-image.image?rcl=2025121118384047886C3B2CB1EA7F871D&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768041561&x-signature=Vxgo3Ykf6OWgjhKCeRnDLNDGKOA%3D"
                    alt="开始对话" class="w-64 h-64 mb-4">
                <h3 class="text-lg font-medium mb-2">开始您的第一次对话</h3>
                <p class="text-text-secondary text-center max-w-md">上传文件或选择左侧指令开始与智能助手交互</p>
            </div>

            <!-- 对话历史 (默认隐藏，有消息时显示) -->
            <div id="chat-history" class="hidden space-y-6">
                <!-- 系统消息 -->
                <div class="flex justify-center">
                    <div class="bg-gray-100 text-text-secondary text-sm px-4 py-2 rounded-full">
                        今天 14:30
                    </div>
                </div>

                <!-- 用户消息 -->
                <div class="flex justify-end">
                    <div class="max-w-[70%]">
                        <div class="flex items-center justify-end mb-1">
                            <span class="text-xs text-text-secondary mr-2">您</span>
                        </div>
                        <div class="message-bubble-user p-3">
                            <p>请帮我分析这份销售数据</p>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 文件上传 -->
                <div class="flex justify-end">
                    <div class="max-w-[70%]">
                        <div class="flex items-center justify-end mb-1">
                            <span class="text-xs text-text-secondary mr-2">您</span>
                        </div>
                        <div class="message-bubble-user p-3">
                            <div class="flex items-center bg-blue-700 p-2 rounded-lg">
                                <i class="fa fa-file-excel-o text-white mr-2"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-medium truncate">销售数据Q3.xlsx</p>
                                    <p class="text-xs text-blue-100">2.5 MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 处理中 -->
                <div class="flex fade-in">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-8 h-8 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-primary text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <div class="flex items-center">
                                <div class="typing-indicator mr-2">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <p class="text-text-secondary">正在处理文件，请稍候...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 处理结果 -->
                <div class="flex">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="flex items-center text-success mb-2">
                                <i class="fa fa-check-circle mr-2"></i>
                                文件上传成功，已添加至知识库
                            </p>
                            <p class="mb-2">我已分析完成您的销售数据，以下是主要发现：</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>Q3总销售额较Q2增长了15.3%</li>
                                <li>华东地区表现最佳，贡献了42%的销售额</li>
                                <li>产品A是销量最高的产品，占比达到38%</li>
                                <li>建议关注华南地区的销售下滑趋势</li>
                            </ul>
                            <div class="mt-3 bg-gray-50 p-2 rounded-lg">
                                <p class="text-sm font-medium">是否需要生成详细的分析报告？</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户消息 -->
                <div class="flex justify-end">
                    <div class="max-w-[70%]">
                        <div class="flex items-center justify-end mb-1">
                            <span class="text-xs text-text-secondary mr-2">您</span>
                        </div>
                        <div class="message-bubble-user p-3">
                            <p>是的，请生成详细报告</p>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 处理中 -->
                <div class="flex">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                                <p>正在生成报告，请稍候...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 处理结果 -->
                <div class="flex">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="mb-2">报告已生成完成，主要内容包括：</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>销售业绩总览</li>
                                <li>各地区销售对比分析</li>
                                <li>产品销售排行榜</li>
                                <li>客户群体分析</li>
                                <li>未来销售趋势预测</li>
                                <li>改进建议</li>
                            </ul>
                            <div class="mt-3 flex">
                                <button class="bg-primary text-white px-3 py-1 rounded-lg text-sm flex items-center">
                                    <i class="fa fa-download mr-1"></i>
                                    下载报告
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 文件已存在示例 -->
                <div class="flex">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="flex items-center text-warning mb-2">
                                <i class="fa fa-exclamation-circle mr-2"></i>
                                文档已存在，不需要再次上传
                            </p>
                            <div class="flex justify-end mt-2">
                                <button id="admin-handle-btn"
                                    class="bg-primary text-white px-3 py-1 rounded-lg text-sm">
                                    处理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统消息 - 相似度较高示例 -->
                <div class="flex">
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div
                                class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="flex items-center text-warning mb-2">
                                <i class="fa fa-search mr-2"></i>
                                检测到相似内容
                            </p>
                            <div class="bg-gray-50 p-2 rounded-lg mb-2">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm truncate">销售数据Q3-更新版.xlsx</span>
                                    <span class="text-xs text-text-secondary">相似度：85%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm truncate">销售数据Q2.xlsx</span>
                                    <span class="text-xs text-text-secondary">相似度：72%</span>
                                </div>
                            </div>
                            <div class="flex justify-end mt-2">
                                <button class="bg-primary text-white px-3 py-1 rounded-lg text-sm">
                                    处理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入框区域 -->
            <div class="p-4 border-t border-border-light bg-white sticky bottom-0 z-10">
                <!-- 文件预览区域 (输入框上方) -->
                <div id="file-preview-container" class="hidden mb-2">
                    <div class="flex items-center justify-between text-sm text-text-secondary mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-medium text-text-primary">附件</span>
                            <span id="preview-count" class="px-2 py-0.5 bg-gray-100 rounded-full text-xs">0</span>
                        </div>
                        <button id="preview-toggle" class="text-primary hover:text-secondary text-xs flex items-center space-x-1">
                            <span>收起</span>
                            <i class="fa fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="file-preview-list" class="space-y-2">
                        <!-- 动态添加文件预览 -->
                    </div>
                </div>
                <div class="flex items-center">
                    <button id="upload-btn"
                        class="p-2 rounded-full hover:bg-gray-100 transition-colors text-text-secondary hover:text-primary relative"
                        title="上传附件">
                        <i class="fa fa-plus text-xl"></i>
                    </button>
                    <div class="flex-1 relative ml-2">
                        <input type="text" id="message-input" placeholder="输入消息..." class="input-primary pr-12">
                        <button id="send-btn"
                            class="hidden absolute right-2 top-1/2 transform -translate-y-1/2 text-white bg-primary rounded-full w-8 h-8 flex items-center justify-center hover:bg-secondary transition-colors">
                            <i class="fa fa-paper-plane-o"></i>
                        </button>
                        <input id="file-input" type="file" class="hidden" multiple>
                    </div>
                </div>
            </div>
    </div>

    <script>
        // ==================== 版本标识 ====================
        const APP_VERSION = 'v2.0.0-fix-20251212';
        console.log('%c🚀 应用版本: ' + APP_VERSION, 'color: #1677FF; font-size: 16px; font-weight: bold;');
        console.log('%c📅 加载时间: ' + new Date().toLocaleString('zh-CN'), 'color: #10b981;');

        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 DOMContentLoaded 事件触发');

            // ==================== DOM元素获取与验证 ====================
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const filePreviewContainer = document.getElementById('file-preview-container');
            const filePreviewList = document.getElementById('file-preview-list');
            const chatHistory = document.getElementById('chat-history');
            const emptyState = document.getElementById('empty-state');
            const chatContainer = document.getElementById('chat-container');
            const previewToggle = document.getElementById('preview-toggle');
            const previewCount = document.getElementById('preview-count');
            const statsPanel = document.getElementById('stats-panel');
            const statsOverlay = document.getElementById('stats-overlay');
            const statsClose = document.getElementById('stats-close');
            const statsPanelMain = document.getElementById('stats-panel-main');
            const statsMainOverlay = document.getElementById('stats-main-overlay');
            const statsResizeHandle = document.getElementById('stats-resize-handle');
            const statsMainClose = document.getElementById('stats-main-close');
            const knowledgePanel = document.getElementById('knowledge-panel');
            const knowledgeOverlay = document.getElementById('knowledge-overlay');
            const knowledgeClose = document.getElementById('knowledge-close');
            const detailPanel = document.getElementById('detail-panel');
            const detailOverlay = document.getElementById('detail-overlay');
            const detailClose = document.getElementById('detail-close');
            const exceptionPanelBody = document.getElementById('exception-panel-body');
            const exceptionListView = document.getElementById('exception-list-view');
            const exceptionDetailView = document.getElementById('exception-detail-view');
            const exceptionDetailContent = document.getElementById('exception-detail-content');
            const exceptionDetailTitle = document.getElementById('exception-detail-title');
            const exceptionDetailType = document.getElementById('exception-detail-type');
            const exceptionDetailPriority = document.getElementById('exception-detail-priority');
            const exceptionDetailTime = document.getElementById('exception-detail-time');
            const exceptionBackBtn = document.getElementById('exception-back-btn');

            // 验证关键DOM元素
            console.log('🔍 关键元素检查:');
            console.log('  - messageInput:', messageInput ? '✅' : '❌');
            console.log('  - sendBtn:', sendBtn ? '✅' : '❌');
            console.log('  - chatHistory:', chatHistory ? '✅' : '❌');

            if (!messageInput || !sendBtn || !chatHistory) {
                console.error('❌ 关键DOM元素未找到，请检查HTML结构！');
                alert('页面初始化失败，请刷新页面重试！');
                return;
            }
            const exceptionPanel = document.getElementById('exception-panel');
            const exceptionOverlay = document.getElementById('exception-overlay');
            const exceptionClose = document.getElementById('exception-close');
            let previewCollapsed = false;

            // ========== 辅助函数 ==========
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const scrollToBottom = () => {
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            };

            const updateActionButtons = () => {
                const hasText = messageInput.value.trim() !== '';
                const hasFiles = filePreviewList.children.length > 0;
                if (hasText || hasFiles) {
                    sendBtn.classList.remove('hidden');
                } else {
                    sendBtn.classList.add('hidden');
                }
            };

            const syncPreviewCollapse = (forceDefault = false) => {
                const items = Array.from(filePreviewList.children);
                const count = items.length;
                if (previewCount) previewCount.textContent = count;

                if (count === 0) {
                    filePreviewContainer.classList.add('hidden');
                    previewCollapsed = false;
                    return;
                }

                filePreviewContainer.classList.remove('hidden');

                if (count > 5 && forceDefault && !previewCollapsed) {
                    previewCollapsed = true;
                }

                if (count <= 5) {
                    previewCollapsed = false;
                }

                items.forEach((item, index) => {
                    const shouldHide = previewCollapsed && index >= 5;
                    item.classList.toggle('hidden', shouldHide);
                });

                if (previewToggle) {
                    previewToggle.querySelector('span').textContent = previewCollapsed ? '展开' : '收起';
                    const icon = previewToggle.querySelector('i');
                    if (icon) icon.className = previewCollapsed ? 'fa fa-chevron-down' : 'fa fa-chevron-up';
                }
            };

            const openStatsPanel = () => {
                statsPanel.classList.remove('translate-x-full');
                if (statsOverlay) statsOverlay.classList.remove('hidden');
            };

            const closeStatsPanel = () => {
                statsPanel.classList.add('translate-x-full');
                if (statsOverlay) statsOverlay.classList.add('hidden');
            };

            if (statsOverlay) {
                statsOverlay.addEventListener('click', closeStatsPanel);
            }

            if (statsClose) {
                statsClose.addEventListener('click', closeStatsPanel);
            }

            // 统计面板(新)
            const openStatsPanelMain = () => {
                if (statsPanelMain) {
                    const savedWidth = localStorage.getItem('stats-panel-width');
                    if (savedWidth) {
                        statsPanelMain.style.width = `${savedWidth}px`;
                    }
                    statsPanelMain.classList.remove('translate-x-full');
                    if (statsMainOverlay) statsMainOverlay.classList.remove('hidden');
                }
            };

            const closeStatsPanelMain = () => {
                if (statsPanelMain) {
                    statsPanelMain.classList.add('translate-x-full');
                }
                if (statsMainOverlay) statsMainOverlay.classList.add('hidden');
            };

            if (statsMainClose) {
                statsMainClose.addEventListener('click', closeStatsPanelMain);
            }
            if (statsMainOverlay) {
                statsMainOverlay.addEventListener('click', closeStatsPanelMain);
            }

            // 知识管理面板
            const openKnowledgePanel = () => {
                if (knowledgePanel) {
                    knowledgePanel.classList.remove('translate-x-full');
                    if (knowledgeOverlay) knowledgeOverlay.classList.remove('hidden');
                }
            };

            const closeKnowledgePanel = () => {
                if (knowledgePanel) {
                    knowledgePanel.classList.add('translate-x-full');
                    if (knowledgeOverlay) knowledgeOverlay.classList.add('hidden');
                }
            };

            if (knowledgeOverlay) {
                knowledgeOverlay.addEventListener('click', closeKnowledgePanel);
            }

            if (knowledgeClose) {
                knowledgeClose.addEventListener('click', closeKnowledgePanel);
            }

            // 统计面板宽度调整功能（与知识/异常保持一致）
            if (statsResizeHandle && statsPanelMain) {
                let isResizingStats = false;
                let startXStats = 0;
                let startWidthStats = 0;

                statsResizeHandle.addEventListener('mousedown', (e) => {
                    isResizingStats = true;
                    startXStats = e.clientX;
                    startWidthStats = statsPanelMain.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    statsPanelMain.style.transition = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizingStats) return;
                    const delta = startXStats - e.clientX;
                    let newWidth = startWidthStats + delta;
                    newWidth = Math.max(500, Math.min(1200, newWidth));
                    statsPanelMain.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isResizingStats) {
                        isResizingStats = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        statsPanelMain.style.transition = '';
                        const width = statsPanelMain.offsetWidth;
                        localStorage.setItem('stats-panel-width', width);
                    }
                });

                statsResizeHandle.addEventListener('dblclick', () => {
                    const defaultWidth = 720;
                    statsPanelMain.style.width = `${defaultWidth}px`;
                    localStorage.setItem('stats-panel-width', defaultWidth);
                });

                const savedStatsWidth = localStorage.getItem('stats-panel-width');
                if (savedStatsWidth) {
                    statsPanelMain.style.width = `${savedStatsWidth}px`;
                }
            }

            // 知识管理面板宽度调整功能
            const panelResizeHandle = document.getElementById('panel-resize-handle');
            if (panelResizeHandle && knowledgePanel) {
                let isResizingPanel = false;
                let startXPanel = 0;
                let startWidthPanel = 0;

                panelResizeHandle.addEventListener('mousedown', (e) => {
                    isResizingPanel = true;
                    startXPanel = e.clientX;
                    startWidthPanel = knowledgePanel.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    // 暂时移除transition以实现流畅拖拽
                    knowledgePanel.style.transition = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizingPanel) return;

                    // 计算新宽度（从右侧拖拽，所以是 startX - currentX）
                    const delta = startXPanel - e.clientX;
                    let newWidth = startWidthPanel + delta;

                    // 限制宽度范围 400px - 1200px
                    newWidth = Math.max(400, Math.min(1200, newWidth));

                    knowledgePanel.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isResizingPanel) {
                        isResizingPanel = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        // 恢复transition
                        knowledgePanel.style.transition = '';

                        // 保存宽度到localStorage
                        const width = knowledgePanel.offsetWidth;
                        localStorage.setItem('knowledge-panel-width', width);
                    }
                });

                // 双击重置宽度
                panelResizeHandle.addEventListener('dblclick', () => {
                    knowledgePanel.style.width = '800px';
                    localStorage.setItem('knowledge-panel-width', '800');
                });

                // 从localStorage恢复宽度
                const savedPanelWidth = localStorage.getItem('knowledge-panel-width');
                if (savedPanelWidth) {
                    knowledgePanel.style.width = `${savedPanelWidth}px`;
                }
            }

            // 异常管理面板宽度调整功能
            const exceptionResizeHandle = document.getElementById('exception-resize-handle');
            if (exceptionResizeHandle && exceptionPanel) {
                let isResizingException = false;
                let startXException = 0;
                let startWidthException = 0;

                exceptionResizeHandle.addEventListener('mousedown', (e) => {
                    isResizingException = true;
                    startXException = e.clientX;
                    startWidthException = exceptionPanel.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    // 暂时移除transition以实现流畅拖拽
                    exceptionPanel.style.transition = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizingException) return;

                    // 计算新宽度（从右侧拖拽，所以是 startX - currentX）
                    const delta = startXException - e.clientX;
                    let newWidth = startWidthException + delta;

                    // 限制宽度范围 500px - 1200px
                    newWidth = Math.max(500, Math.min(1200, newWidth));

                    exceptionPanel.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isResizingException) {
                        isResizingException = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        // 恢复transition
                        exceptionPanel.style.transition = '';

                        // 保存宽度到localStorage
                        const width = exceptionPanel.offsetWidth;
                        localStorage.setItem('exception-panel-width', width);
                    }
                });

                // 双击重置宽度
                exceptionResizeHandle.addEventListener('dblclick', () => {
                    exceptionPanel.style.width = '720px';
                    localStorage.setItem('exception-panel-width', '720');
                });

                // 从localStorage恢复宽度
                const savedExceptionWidth = localStorage.getItem('exception-panel-width');
                if (savedExceptionWidth) {
                    exceptionPanel.style.width = `${savedExceptionWidth}px`;
                }
            }

            // 库类型切换（文档库 / FAQ库）
            const tabDocLibrary = document.getElementById('tab-doc-library');
            const tabFaqLibrary = document.getElementById('tab-faq-library');
            const docLibraryContent = document.getElementById('doc-library-content');
            const faqLibraryContent = document.getElementById('faq-library-content');

            if (tabDocLibrary) {
                tabDocLibrary.addEventListener('click', () => {
                    // 切换标签样式
                    tabDocLibrary.classList.add('border-teal-600', 'text-teal-600', 'bg-teal-50');
                    tabDocLibrary.classList.remove('border-transparent', 'text-text-secondary');
                    tabFaqLibrary.classList.remove('border-teal-600', 'text-teal-600', 'bg-teal-50');
                    tabFaqLibrary.classList.add('border-transparent', 'text-text-secondary');

                    // 切换内容区域
                    if (docLibraryContent) {
                        docLibraryContent.classList.remove('hidden');
                        docLibraryContent.classList.add('flex');
                    }
                    if (faqLibraryContent) {
                        faqLibraryContent.classList.add('hidden');
                        faqLibraryContent.classList.remove('flex');
                    }
                });
            }

            if (tabFaqLibrary) {
                tabFaqLibrary.addEventListener('click', () => {
                    // 切换标签样式
                    tabFaqLibrary.classList.add('border-teal-600', 'text-teal-600', 'bg-teal-50');
                    tabFaqLibrary.classList.remove('border-transparent', 'text-text-secondary');
                    tabDocLibrary.classList.remove('border-teal-600', 'text-teal-600', 'bg-teal-50');
                    tabDocLibrary.classList.add('border-transparent', 'text-text-secondary');

                    // 切换内容区域
                    if (faqLibraryContent) {
                        faqLibraryContent.classList.remove('hidden');
                        faqLibraryContent.classList.add('flex');
                    }
                    if (docLibraryContent) {
                        docLibraryContent.classList.add('hidden');
                        docLibraryContent.classList.remove('flex');
                    }

                    // 加载FAQ列表
                    loadFaqList();
                });
            }

            // 删除旧的标签页逻辑，因为我们已经改为库类型切换
            const tabDocuments = document.getElementById('tab-documents');
            const tabFaq = document.getElementById('tab-faq');

            if (false && tabFaq) {  // 禁用旧代码
                tabFaq.addEventListener('click', () => {
                    // 切换标签样式
                    tabFaq.classList.add('border-teal-600', 'text-teal-600');
                    tabFaq.classList.remove('border-transparent', 'text-text-secondary');
                    tabDocuments.classList.remove('border-teal-600', 'text-teal-600');
                    tabDocuments.classList.add('border-transparent', 'text-text-secondary');
                    // 切换内容
                    if (contentFaq) contentFaq.classList.remove('hidden');
                    if (contentDocuments) contentDocuments.classList.add('hidden');
                });
            }

            if (previewToggle) {
                previewToggle.addEventListener('click', () => {
                    previewCollapsed = !previewCollapsed;
                    syncPreviewCollapse();
                });
            }

            const formatFileSize = (bytes) => {
                if (!bytes) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
            };

            const addUserMessage = (text) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex justify-end';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center justify-end mb-1">
                            <span class="text-xs text-text-secondary mr-2">您</span>
                        </div>
                        <div class="message-bubble-user p-3">
                            <p>${text}</p>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
            };

            const addFileToChat = (name, size) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center justify-end mb-1">
                            <span class="text-xs text-text-secondary mr-2">您</span>
                        </div>
                        <div class="message-bubble-user p-3">
                            <div class="flex items-center bg-blue-700 p-2 rounded-lg">
                                <i class="fa fa-file-o text-white mr-2"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-medium truncate">${name}</p>
                                    <p class="text-xs text-blue-100">${size}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(messageDiv);
            };

            const addSystemMessage = (text) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p>${text}</p>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
            };

            const addSearchResultMessage = (query) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex fade-in';
                const results = [
                    { name: '销售数据Q3.xlsx', size: '2.5 MB', date: '2023-10-15' },
                    { name: '往年销售对比.pdf', size: '1.2 MB', date: '2023-09-20' }
                ];
                const resultsHtml = results.map(file => `
                    <div class="bg-white border border-border-light rounded-lg p-3 mb-2 hover:shadow-sm transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded bg-blue-100 text-primary flex items-center justify-center mr-3">
                                    <i class="fa ${file.name.endsWith('pdf') ? 'fa-file-pdf-o' : 'fa-file-excel-o'}"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-sm text-text-primary">${file.name}</p>
                                    <p class="text-xs text-text-secondary">${file.size} • ${file.date}</p>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                <button class="p-1 text-text-secondary hover:text-primary transition-colors" title="查看">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <button class="p-1 text-text-secondary hover:text-error transition-colors delete-file-btn"
                                    data-name="${file.name}" title="删除">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                wrapper.innerHTML = `
                    <div class="max-w-[85%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-4 bg-gray-50 border border-border-light">
                            <p class="mb-3 text-text-primary">🔍 为您找到以下与"${query}"相关的内容：</p>
                            ${resultsHtml}
                            <button
                                class="w-full py-2 text-center text-sm text-primary hover:text-secondary transition-colors border-t border-gray-200 mt-1">
                                查看更多结果
                            </button>
                        </div>
                    </div>
                `;

                chatHistory.appendChild(wrapper);
            };

            const clearInputState = () => {
                messageInput.value = '';
                filePreviewList.innerHTML = '';
                syncPreviewCollapse();
                updateActionButtons();
            };

            const addStatsMessage = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="mb-3">统计分析结果已生成，可点击查看详细图表。</p>
                            <div class="flex space-x-2">
                                <button class="btn-primary text-sm px-3 py-1.5 open-stats-btn">查看统计面板</button>
                                <button class="btn-secondary text-sm px-3 py-1.5">发送摘要</button>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
                const openBtn = wrapper.querySelector('.open-stats-btn');
                if (openBtn) {
                    openBtn.addEventListener('click', openStatsPanelMain);
                }
            };

            const addExceptionMessage = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="mb-3">已为您准备异常处理入口，可批量管理文档冲突、待分类文档和FAQ待审。</p>
                            <div class="flex space-x-2">
                                <button class="btn-primary text-sm px-3 py-1.5 open-exception-btn">打开异常处理面板</button>
                                <button class="btn-secondary text-sm px-3 py-1.5">继续对话处理</button>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
                const openBtn = wrapper.querySelector('.open-exception-btn');
                if (openBtn) {
                    openBtn.addEventListener('click', openExceptionPanel);
                }
            };

            const addKnowledgeManagementMessage = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="mb-3">已为您准备知识管理入口，可以查看文档库和FAQ库。</p>
                            <div class="flex space-x-2">
                                <button class="btn-primary text-sm px-3 py-1.5 open-knowledge-btn">打开知识管理面板</button>
                                <button class="btn-secondary text-sm px-3 py-1.5">继续对话处理</button>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
                const openBtn = wrapper.querySelector('.open-knowledge-btn');
                if (openBtn) {
                    openBtn.addEventListener('click', openKnowledgePanel);
                }
            };

            const sendMessage = () => {
                console.log('📤 sendMessage 函数被调用');
                const text = messageInput.value.trim();
                const files = Array.from(filePreviewList.children);
                console.log('📝 消息内容:', text);
                console.log('📎 文件数量:', files.length);

                if (!text && files.length === 0) {
                    console.log('❌ 消息为空，取消发送');
                    return;
                }

                console.log('✅ 开始发送消息');
                if (emptyState) {
                    emptyState.classList.add('hidden');
                }
                chatHistory.classList.remove('hidden');

                if (text) {
                    addUserMessage(text);
                }

                files.forEach((item) => {
                    const name = item.getAttribute('data-name');
                    const size = item.getAttribute('data-size');
                    addFileToChat(name, size);
                });

                clearInputState();
                scrollToBottom();

                setTimeout(() => {
                    addSystemMessage('正在处理您的请求，请稍候...');
                    scrollToBottom();

                    setTimeout(() => {
                        const lower = text.toLowerCase();
                        if (text.includes('统计') || text.includes('分析') || text.includes('数据')) {
                            // 统计分析相关
                            addStatsMessage();
                        } else if (text.includes('异常') && (text.includes('处理') || text.includes('查看') || text.includes('批量'))) {
                            // 异常处理相关
                            addExceptionMessage();
                        } else if (text.includes('知识') && (text.includes('管理') || text.includes('库'))) {
                            // 知识管理相关
                            addKnowledgeManagementMessage();
                        } else if (text.includes('搜索') || text.includes('查找') || text.includes('找')) {
                            addSearchResultMessage(text);
                        } else {
                            addSystemMessage('我已完成您的请求，这是处理结果。');
                        }
                        scrollToBottom();
                    }, 800);
                }, 500);
            };

            const makeUniqueName = (name) => {
                const existing = new Set(
                    Array.from(filePreviewList.children).map((item) => item.getAttribute('data-name'))
                );
                if (!existing.has(name)) return name;

                const dotIndex = name.lastIndexOf('.');
                const base = dotIndex > -1 ? name.slice(0, dotIndex) : name;
                const ext = dotIndex > -1 ? name.slice(dotIndex) : '';

                let counter = 1;
                let candidate = '';
                do {
                    candidate = `${base}(${counter})${ext}`;
                    counter += 1;
                } while (existing.has(candidate));

                return candidate;
            };

            const addFilePreview = (file) => {
                const uniqueName = makeUniqueName(file.name);
                const sizeText = formatFileSize(file.size);
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg';
                fileItem.setAttribute('data-name', uniqueName);
                fileItem.setAttribute('data-size', sizeText);
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-file-o text-primary mr-2"></i>
                        <div>
                            <p class="text-sm font-medium truncate">${uniqueName}</p>
                            <p class="text-xs text-text-secondary">${sizeText}</p>
                        </div>
                    </div>
                    <button class="text-text-secondary hover:text-error remove-file">
                        <i class="fa fa-times"></i>
                    </button>
                `;

                fileItem.querySelector('.remove-file').addEventListener('click', () => {
                    fileItem.remove();
                    syncPreviewCollapse();
                    updateActionButtons();
                });

                filePreviewList.appendChild(fileItem);
                syncPreviewCollapse(true);
            };

            // ========== 增强的文件上传逻辑（需要先定义）==========
            async function handleEnhancedFileUpload(files) {
                if (!files || files.length === 0) return;

                const file = files[0]; // 处理第一个文件

                // 1. 显示上传中消息
                addSystemMessage(`正在上传文件：${file.name}`);
                await sleep(500);

                // 2. 模拟file hash检测
                const isDuplicate = Math.random() < 0.2; // 20%概率重复
                if (isDuplicate) {
                    const filenameSame = Math.random() < 0.5;
                    if (filenameSame) {
                        // 场景1：完全重复
                        addSystemMessage(`检测到文档已存在：《${file.name}》
录入时间：2024-11-28 10:00:00
录入人：张经理

这两份文档内容完全一样，不需要重复处理。`);
                        return;
                    } else {
                        // 场景2：内容相同但文件名不同
                        addSystemMessageWithActions(`文档内容已存在，但文件名不同：
已有文档：《2024年${file.name}》
新文件名：《${file.name}》

您希望：`, [
                            { label: '保持原文件名', action: 'keep_existing' },
                            { label: '更新文件名', action: 'update_filename' },
                            { label: '取消', action: 'cancel' }
                        ]);
                        return;
                    }
                }

                // 3. 显示L0-L2处理进度
                const progressMsg = createProgressMessage();

                await sleep(500);
                updateProgressStage(progressMsg, 'l0', 'processing');
                await sleep(800);
                updateProgressStage(progressMsg, 'l0', 'completed');

                updateProgressStage(progressMsg, 'l1', 'processing');
                await sleep(2000);
                updateProgressStage(progressMsg, 'l1', 'completed');

                updateProgressStage(progressMsg, 'l2', 'processing');
                await sleep(1500);
                updateProgressStage(progressMsg, 'l2', 'completed');

                // 4. 相似度检测
                const hasSimilar = Math.random() < 0.3; // 30%概率发现相似
                if (hasSimilar) {
                    await sleep(500);
                    addSystemMessageWithActions(`检测到相似内容！

相似文档：《2024年产假政策》
相似度：92%

主要差异：
• 新增体检医院信息
• 更新银行卡要求`, [
                        { label: '处理', icon: 'cog', action: 'open_conflict_panel', data: {
                            similarDoc: { title: '2024年产假政策', created_at: '2024-11-28 10:00:00' },
                            similarity: 92,
                            differences: ['新增体检医院信息', '更新银行卡要求']
                        }}
                    ]);
                    return;
                }

                // 5. L3处理（分类、标签、摘要）
                await sleep(500);
                updateProgressMessage(progressMsg, '正在提取知识...');
                updateProgressStage(progressMsg, 'l3', 'processing');
                await sleep(2000);
                updateProgressStage(progressMsg, 'l3', 'completed');

                const categoryConfidence = Math.random();
                if (categoryConfidence < 0.7) {
                    // 分类置信度低，需要确认
                    await sleep(500);
                    addSystemMessageWithActions(`文档上传成功！但我不太确定这份文档的分类：

我的猜测（不确定）：
• 公司主体：集团总部（置信度${Math.round(categoryConfidence * 100)}%）
• 业务领域：员工福利/假期管理

能帮我确认一下吗？`, [
                        { label: '确认分类', icon: 'folder', action: 'open_category_panel', data: {
                            category: { company_entity: '集团总部', business_domain: '员工福利/假期管理' },
                            categoryConfidence: categoryConfidence,
                            tags: ['产假', '陪产假', '生育津贴'],
                            summary: '规定员工产假、陪产假的天数和生育津贴的领取流程'
                        }}
                    ]);
                    return;
                }

                // 6. QA挖掘（智能推荐模式）
                await sleep(500);
                updateProgressMessage(progressMsg, '正在挖掘FAQ...');
                updateProgressStage(progressMsg, 'qa', 'processing');
                await sleep(2000);
                updateProgressStage(progressMsg, 'qa', 'completed');

                // 智能分类：高置信度自动入库，低置信度或冲突需要审核
                const totalFaqs = Math.floor(Math.random() * 20) + 10;
                const needReviewCount = Math.floor(Math.random() * 5);
                const autoApprovedCount = totalFaqs - needReviewCount;

                if (needReviewCount > 0) {
                    await sleep(500);
                    addSystemMessageWithActions(`从文档中挖掘出 ${totalFaqs} 条FAQ：
• 自动入库：${autoApprovedCount} 条（高置信度）
• 需要审核：${needReviewCount} 条（低置信度或与已有FAQ相似）`, [
                        { label: '审核FAQ', icon: 'question-circle', action: 'open_faq_panel', data: {
                            needReview: [{
                                question: '产假有多少天？',
                                answer: '根据最新政策，产假为158天，包括基本产假98天和延长产假60天。',
                                similar_qa: {
                                    question: '产假天数是多少？',
                                    answer: '根据2024年政策，产假为128天...'
                                },
                                similarity: 0.95
                            }],
                            autoApproved: []
                        }}
                    ]);
                } else {
                    // 全部自动入库
                    await sleep(500);
                    addSystemMessage(`文档处理完成！

• 文档已入库，可正常检索
• 自动分类：员工福利/假期管理
• 提取标签：产假、陪产假、生育津贴
• 挖掘FAQ：${totalFaqs} 条（已自动入库）`);
                }
            }

            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', async (event) => {
                const files = Array.from(event.target.files || []);
                files.forEach(addFilePreview);
                updateActionButtons();

                // 触发完整的文档处理流程
                if (files.length > 0) {
                    await handleEnhancedFileUpload(files);
                }
            });

            sendBtn.addEventListener('click', () => {
                console.log('🖱️ 点击发送按钮');
                sendMessage();
            });

            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    console.log('⌨️ 按下Enter键');
                    event.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', updateActionButtons);

            const commandCards = document.querySelectorAll('.command-card');
            console.log('🔧 找到快捷指令数量:', commandCards.length);
            commandCards.forEach((card, index) => {
                const title = card.querySelector('h3') ? card.querySelector('h3').textContent.trim() : '';
                console.log(`🔧 注册快捷指令 ${index + 1}:`, title);
                card.addEventListener('click', () => {
                    if (!title) return;

                    console.log('🖱️ 点击快捷指令:', title);
                    // 所有卡片：填入输入框，通过对话式交互触发
                    messageInput.value = title;
                    messageInput.focus();
                    updateActionButtons();
                    console.log('✅ 已填充到输入框，当前值:', messageInput.value);
                });
            });

            updateActionButtons();

            // ========== 新功能：进度条组件 ==========
            function createProgressMessage() {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex fade-in';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <p class="mb-3 progress-message-text">正在处理文档...</p>
                            <div class="space-y-2 progress-stages">
                                <!-- 动态插入进度条 -->
                            </div>
                        </div>
                    </div>
                `;
                chatHistory.appendChild(wrapper);
                scrollToBottom();
                return wrapper;
            }

            function updateProgressStage(wrapper, stage, status) {
                const stagesContainer = wrapper.querySelector('.progress-stages');
                const stageLabels = {
                    'l0': 'L0 文件存储',
                    'l1': 'L1 文档解析',
                    'l2': 'L2 向量化',
                    'l3': 'L3 知识提取',
                    'qa': 'QA 挖掘'
                };

                let stageEl = stagesContainer.querySelector(`[data-stage="${stage}"]`);
                if (!stageEl) {
                    stageEl = document.createElement('div');
                    stageEl.className = 'flex items-center space-x-2';
                    stageEl.setAttribute('data-stage', stage);
                    stageEl.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm text-text-secondary">${stageLabels[stage]}</span>
                                <span class="stage-status text-xs"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="stage-progress bg-primary h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    `;
                    stagesContainer.appendChild(stageEl);
                }

                const progressBar = stageEl.querySelector('.stage-progress');
                const statusEl = stageEl.querySelector('.stage-status');

                switch(status) {
                    case 'processing':
                        progressBar.style.width = '50%';
                        statusEl.innerHTML = '<i class="fa fa-spinner fa-spin text-primary"></i>';
                        break;
                    case 'completed':
                        progressBar.style.width = '100%';
                        statusEl.innerHTML = '<i class="fa fa-check-circle text-success"></i>';
                        break;
                    case 'error':
                        progressBar.style.width = '100%';
                        progressBar.classList.remove('bg-primary');
                        progressBar.classList.add('bg-error');
                        statusEl.innerHTML = '<i class="fa fa-exclamation-circle text-error"></i>';
                        break;
                }
                scrollToBottom();
            }

            function updateProgressMessage(wrapper, text) {
                const messageText = wrapper.querySelector('.progress-message-text');
                if (messageText) {
                    messageText.textContent = text;
                }
            }

            // ========== 新功能：带操作按钮的消息 ==========
            function addSystemMessageWithActions(text, actions) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex fade-in';
                wrapper.innerHTML = `
                    <div class="max-w-[70%]">
                        <div class="flex items-center mb-1">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center mr-2">
                                <i class="fa fa-robot text-xs"></i>
                            </div>
                            <span class="text-xs text-text-secondary">智能助手</span>
                        </div>
                        <div class="message-bubble-system p-3">
                            <div class="message-text whitespace-pre-line">${text}</div>
                            ${actions && actions.length > 0 ? `
                                <div class="flex space-x-2 mt-3 pt-3 border-t border-gray-200">
                                    ${actions.map((action, index) => `
                                        <button class="btn-primary text-sm px-3 py-1.5 action-btn" data-index="${index}">
                                            ${action.icon ? `<i class="fa fa-${action.icon} mr-1"></i>` : ''}
                                            ${action.label}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // 绑定按钮事件
                if (actions && actions.length > 0) {
                    actions.forEach((action, index) => {
                        const btn = wrapper.querySelector(`[data-index="${index}"]`);
                        if (btn) {
                            btn.addEventListener('click', () => {
                                handleActionClick(action.action, action.data || {});
                            });
                        }
                    });
                }

                chatHistory.appendChild(wrapper);
                scrollToBottom();
                return wrapper;
            }

            // ========== 新功能：处理操作点击 ==========
            function handleActionClick(action, data) {
                switch(action) {
                    case 'open_conflict_panel':
                        openDetailPanel('conflict', data);
                        break;
                    case 'open_category_panel':
                        openDetailPanel('category', data);
                        break;
                    case 'open_faq_panel':
                        openDetailPanel('faq', data);
                        break;
                    case 'open_exception_panel':
                        openExceptionPanel();
                        break;
                    case 'keep_existing':
                        addSystemMessage('好的，保持原有文件名。');
                        break;
                    case 'update_filename':
                        addSystemMessage('文件名已更新。');
                        break;
                    case 'cancel':
                        addSystemMessage('已取消上传。');
                        break;
                    default:
                        console.log('Unknown action:', action);
                }
            }

            // ========== 新功能：面板管理 ==========
            function openDetailPanel(type, data) {
                const titleEl = document.getElementById('detail-title');
                const iconEl = document.getElementById('detail-icon');
                const contentEl = document.getElementById('detail-content');

                // 设置标题和图标
                switch(type) {
                    case 'conflict':
                        titleEl.textContent = '文档冲突处理';
                        iconEl.className = 'fa fa-exclamation-triangle text-warning text-lg';
                        contentEl.innerHTML = generateConflictDetail(data);
                        break;
                    case 'category':
                        titleEl.textContent = '分类确认';
                        iconEl.className = 'fa fa-folder text-primary text-lg';
                        contentEl.innerHTML = generateCategoryDetail(data);
                        break;
                    case 'faq':
                        titleEl.textContent = 'FAQ审核';
                        iconEl.className = 'fa fa-question-circle text-primary text-lg';
                        contentEl.innerHTML = generateFaqDetail(data);
                        break;
                }

                // 显示面板
                detailPanel.classList.remove('translate-x-full');
                detailOverlay.classList.remove('hidden');
            }

            function closeDetailPanel() {
                detailPanel.classList.add('translate-x-full');
                detailOverlay.classList.add('hidden');
            }

            function showExceptionListView() {
                if (exceptionListView) exceptionListView.classList.remove('hidden');
                if (exceptionDetailView) exceptionDetailView.classList.add('hidden');
                if (exceptionPanelBody) exceptionPanelBody.scrollTop = 0;
            }

            function showExceptionDetailView(meta, detailHtml) {
                if (exceptionDetailTitle) exceptionDetailTitle.textContent = meta.title || '异常详情';
                if (exceptionDetailType) exceptionDetailType.textContent = `${getExceptionTypeLabel(meta.type)} · 详情`;
                if (exceptionDetailTime) exceptionDetailTime.textContent = meta.time || '';
                setPriorityBadge(exceptionDetailPriority, meta.priority);

                if (exceptionDetailContent) {
                    exceptionDetailContent.innerHTML = detailHtml || '<p class="text-sm text-text-secondary">暂无详细信息</p>';
                }

                if (exceptionListView) exceptionListView.classList.add('hidden');
                if (exceptionDetailView) exceptionDetailView.classList.remove('hidden');
                if (exceptionPanelBody) {
                    exceptionPanelBody.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            function getExceptionTypeLabel(type) {
                switch(type) {
                    case 'conflict':
                        return '文档冲突';
                    case 'category':
                        return '待分类';
                    case 'faq':
                        return 'FAQ待审';
                    default:
                        return '异常';
                }
            }

            function setPriorityBadge(el, priority) {
                if (!el) return;
                const priorityMap = {
                    high: { text: '高', classes: 'bg-red-100 text-red-800' },
                    medium: { text: '中', classes: 'bg-yellow-100 text-yellow-800' },
                    low: { text: '低', classes: 'bg-green-100 text-green-800' }
                };
                const current = priorityMap[priority] || priorityMap.medium;
                el.textContent = current.text;
                el.className = `px-2 py-1 rounded-full text-xs ${current.classes}`;
            }

            function openExceptionPanel() {
                initExceptionList();
                showExceptionListView();
                exceptionPanel.classList.remove('translate-x-full');
                exceptionOverlay.classList.remove('hidden');
            }

            function closeExceptionPanel() {
                exceptionPanel.classList.add('translate-x-full');
                exceptionOverlay.classList.add('hidden');
            }

            // 绑定面板关闭事件
            if (detailClose) {
                detailClose.addEventListener('click', closeDetailPanel);
            }
            if (detailOverlay) {
                detailOverlay.addEventListener('click', closeDetailPanel);
            }
            if (exceptionClose) {
                exceptionClose.addEventListener('click', closeExceptionPanel);
            }
            if (exceptionOverlay) {
                exceptionOverlay.addEventListener('click', closeExceptionPanel);
            }
            if (exceptionBackBtn) {
                exceptionBackBtn.addEventListener('click', showExceptionListView);
            }

            // ========== 新功能：面板详情生成 ==========
            function generateConflictDetail(data) {
                const { similarDoc, similarity, differences } = data;
                return `
                    <div class="space-y-4">
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <p class="text-sm text-yellow-800">
                                <i class="fa fa-info-circle mr-2"></i>
                                检测到与已有文档高度相似，请确认处理方式
                            </p>
                        </div>

                        <div class="bg-white rounded-lg border border-border-light p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3">相似文档信息</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-text-secondary">文档标题：</span>
                                    <span class="text-sm text-text-primary font-medium">${similarDoc.title}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-text-secondary">录入时间：</span>
                                    <span class="text-sm text-text-primary">${similarDoc.created_at}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-text-secondary">相似度：</span>
                                    <div class="flex items-center">
                                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-warning h-2 rounded-full" style="width: ${similarity}%"></div>
                                        </div>
                                        <span class="text-sm font-semibold text-warning">${similarity}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${differences && differences.length > 0 ? `
                            <div class="bg-white rounded-lg border border-border-light p-4">
                                <h3 class="text-sm font-semibold text-text-primary mb-3">主要差异</h3>
                                <ul class="space-y-2">
                                    ${differences.map(diff => `
                                        <li class="flex items-start text-sm text-text-primary">
                                            <i class="fa fa-circle text-primary text-xs mr-2 mt-1"></i>
                                            <span>${diff}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        <div class="bg-white rounded-lg border border-border-light p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3">处理选项</h3>
                            <div class="space-y-2">
                                <button onclick="handleReplaceDocument()" class="w-full flex items-center justify-between px-4 py-3 bg-primary text-white rounded-lg hover:bg-secondary transition-all">
                                    <div class="flex items-center">
                                        <i class="fa fa-refresh mr-3"></i>
                                        <span>覆盖为新版本</span>
                                    </div>
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                                <button onclick="handleKeepBoth()" class="w-full flex items-center justify-between px-4 py-3 bg-white text-text-primary border border-border-light rounded-lg hover:bg-gray-50 transition-all">
                                    <div class="flex items-center">
                                        <i class="fa fa-copy mr-3"></i>
                                        <span>保留两个版本</span>
                                    </div>
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                                <button onclick="handleIgnore()" class="w-full flex items-center justify-between px-4 py-3 bg-white text-text-secondary border border-border-light rounded-lg hover:bg-gray-50 transition-all">
                                    <div class="flex items-center">
                                        <i class="fa fa-ban mr-3"></i>
                                        <span>忽略</span>
                                    </div>
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function generateCategoryDetail(data) {
                const { category, categoryConfidence, tags, summary } = data;
                return `
                    <div class="space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <p class="text-sm text-blue-800">
                                <i class="fa fa-info-circle mr-2"></i>
                                系统自动分类置信度较低，请确认或修改分类
                            </p>
                        </div>

                        <div class="bg-white rounded-lg border border-border-light p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3">系统推荐分类</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm text-text-secondary mb-2">公司主体（置信度: ${Math.round(categoryConfidence * 100)}%）</label>
                                    <input type="text" class="input-primary" value="${category.company_entity}" id="category-entity">
                                </div>
                                <div>
                                    <label class="block text-sm text-text-secondary mb-2">业务领域</label>
                                    <select class="input-primary" id="category-domain">
                                        <option value="${category.business_domain}" selected>${category.business_domain}</option>
                                        <option value="入转调离/入职服务">入转调离/入职服务</option>
                                        <option value="员工福利/假期管理">员工福利/假期管理</option>
                                        <option value="员工关系/员工服务">员工关系/员工服务</option>
                                        <option value="培训发展">培训发展</option>
                                        <option value="招聘管理">招聘管理</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        ${tags && tags.length > 0 ? `
                            <div class="bg-white rounded-lg border border-border-light p-4">
                                <h3 class="text-sm font-semibold text-text-primary mb-3">提取标签</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${tags.map(tag => `
                                        <span class="px-3 py-1 bg-primary bg-opacity-10 text-primary rounded-full text-sm">
                                            ${tag}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex space-x-2">
                            <button onclick="handleSaveCategory()" class="flex-1 btn-primary">
                                <i class="fa fa-check mr-2"></i>保存分类
                            </button>
                            <button onclick="closeDetailPanel()" class="flex-1 btn-secondary">
                                稍后处理
                            </button>
                        </div>
                    </div>
                `;
            }

            function generateFaqDetail(data) {
                const { needReview, autoApproved } = data;
                if (!needReview || needReview.length === 0) {
                    return '<p class="text-center text-text-secondary py-8">暂无需要审核的FAQ</p>';
                }

                const currentFaq = needReview[0];
                return `
                    <div class="space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <p class="text-sm text-blue-800">
                                <i class="fa fa-info-circle mr-2"></i>
                                共 ${needReview.length} 条FAQ需要审核，${autoApproved ? autoApproved.length : 0} 条已自动入库
                            </p>
                        </div>

                        <div class="bg-white rounded-lg border border-border-light p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3">问题</h3>
                            <p class="text-sm text-text-primary">${currentFaq.question || '产假有多少天？'}</p>
                        </div>

                        <div class="bg-white rounded-lg border border-border-light p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3">答案</h3>
                            <div class="bg-gray-50 p-3 rounded text-sm text-text-primary">
                                ${currentFaq.answer || '根据最新政策，产假为158天，包括基本产假98天和延长产假60天。'}
                            </div>
                        </div>

                        ${currentFaq.similar_qa ? `
                            <div class="bg-yellow-50 rounded-lg border border-yellow-200 p-4">
                                <h3 class="text-sm font-semibold text-yellow-800 mb-3">
                                    <i class="fa fa-exclamation-triangle mr-2"></i>发现相似问题
                                </h3>
                                <div class="space-y-2">
                                    <div class="text-sm">
                                        <span class="text-text-secondary">相似问题：</span>
                                        <span class="text-text-primary">${currentFaq.similar_qa.question}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-text-secondary">已有答案：</span>
                                        <span class="text-text-primary">${currentFaq.similar_qa.answer}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-text-secondary">相似度：</span>
                                        <span class="font-semibold text-warning">${currentFaq.similarity ? Math.round(currentFaq.similarity * 100) : 95}%</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex space-x-2">
                            <button onclick="handleApproveFaq()" class="flex-1 btn-primary">
                                <i class="fa fa-check mr-2"></i>批准发布
                            </button>
                            <button onclick="handleRejectFaq()" class="flex-1 btn-secondary">
                                <i class="fa fa-times mr-2"></i>驳回
                            </button>
                        </div>

                        ${needReview.length > 1 ? `
                            <div class="text-center text-sm text-text-secondary">
                                1 / ${needReview.length}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ========== 新功能：处理操作函数 ==========
            window.handleReplaceDocument = function() {
                closeDetailPanel();
                addSystemMessage('已将旧版本归档，新版本已激活！');
            };

            window.handleKeepBoth = function() {
                closeDetailPanel();
                addSystemMessage('已保留两个版本，均可正常检索。');
            };

            window.handleIgnore = function() {
                closeDetailPanel();
                addSystemMessage('已忽略相似检测，文档继续处理。');
            };

            window.handleSaveCategory = function() {
                const entity = document.getElementById('category-entity')?.value;
                const domain = document.getElementById('category-domain')?.value;
                closeDetailPanel();
                addSystemMessage(`分类已确认：${entity} - ${domain}`);
            };

            window.handleApproveFaq = function() {
                closeDetailPanel();
                addSystemMessage('FAQ已批准发布，可用于检索！');
            };

            window.handleRejectFaq = function() {
                closeDetailPanel();
                addSystemMessage('FAQ已驳回。');
            };

            // ========== 新功能：异常列表初始化 ==========
            function initExceptionList() {
                const mockExceptions = [
                    { id: 1, title: '2025年产假政策 vs 2024年产假政策', type: 'conflict', time: '2025-12-12 10:30', priority: 'high' },
                    { id: 2, title: '员工心理健康咨询服务指南', type: 'category', time: '2025-12-12 10:25', priority: 'medium' },
                    { id: 3, title: 'FAQ: 产假有多少天？', type: 'faq', time: '2025-12-12 10:20', priority: 'low' },
                    { id: 4, title: '远程办公申请流程文档', type: 'category', time: '2025-12-12 10:15', priority: 'medium' },
                    { id: 5, title: '新员工入职指南 vs 入职指南2025', type: 'conflict', time: '2025-12-12 10:10', priority: 'high' },
                ];

                const listEl = document.getElementById('exception-list');
                if (listEl) {
                    listEl.innerHTML = mockExceptions.map(ex => `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3">
                                <input type="checkbox" class="w-4 h-4 exception-checkbox" data-exception-id="${ex.id}" data-exception-type="${ex.type}">
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <i class="fa fa-${ex.type === 'conflict' ? 'exclamation-triangle text-warning' : ex.type === 'category' ? 'folder text-primary' : 'question-circle text-blue-500'} mr-2"></i>
                                    <span class="text-sm text-text-primary">${ex.title}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs ${ex.type === 'conflict' ? 'bg-red-100 text-red-800' : ex.type === 'category' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                    ${ex.type === 'conflict' ? '文档冲突' : ex.type === 'category' ? '待分类' : 'FAQ待审'}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-text-secondary">${ex.time}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs ${ex.priority === 'high' ? 'bg-red-100 text-red-800' : ex.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                    ${ex.priority === 'high' ? '高' : ex.priority === 'medium' ? '中' : '低'}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <button onclick="handleExceptionDetail('${ex.type}', ${ex.id})" class="text-primary hover:text-secondary text-sm">
                                    <i class="fa fa-eye mr-1"></i>查看详情
                                </button>
                            </td>
                        </tr>
                    `).join('');

                    // 绑定批量选择事件
                    bindExceptionCheckboxEvents();
                }
            }

            function buildExceptionDetailHtml(type) {
                const data = getMockDataByType(type);
                switch(type) {
                    case 'conflict':
                        return generateConflictDetail(data);
                    case 'category':
                        return generateCategoryDetail(data);
                    case 'faq':
                        return generateFaqDetail(data);
                    default:
                        return '<p class="text-sm text-text-secondary">暂无详细信息</p>';
                }
            }

            window.handleExceptionDetail = function(type, id) {
                const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${id}"]`);
                const row = checkbox ? checkbox.closest('tr') : null;
                const title = row?.querySelector('td:nth-child(2) span')?.textContent?.trim() || '异常详情';
                const time = row?.querySelector('td:nth-child(4)')?.textContent?.trim() || '';
                const priorityText = row?.querySelector('td:nth-child(5) span')?.textContent?.trim() || '';
                const priority = priorityText.includes('高') ? 'high' : priorityText.includes('低') ? 'low' : 'medium';

                const detailHtml = buildExceptionDetailHtml(type);
                showExceptionDetailView({ id, type, title, time, priority }, detailHtml);
            };

            function getMockDataByType(type) {
                switch(type) {
                    case 'conflict':
                        return {
                            similarDoc: { title: '2024年产假政策', created_at: '2024-11-28 10:00:00' },
                            similarity: 92,
                            differences: ['新增体检医院信息', '更新银行卡要求']
                        };
                    case 'category':
                        return {
                            category: { company_entity: '集团总部', business_domain: '员工关系/员工服务' },
                            categoryConfidence: 0.65,
                            tags: ['心理健康', '员工关怀', '咨询服务'],
                            summary: '介绍员工心理健康咨询服务的申请流程'
                        };
                    case 'faq':
                        return {
                            needReview: [{
                                question: '产假有多少天？',
                                answer: '根据最新政策，产假为158天，包括基本产假98天和延长产假60天。',
                                similar_qa: {
                                    question: '产假天数是多少？',
                                    answer: '根据2024年政策，产假为128天...',
                                },
                                similarity: 0.95
                            }],
                            autoApproved: []
                        };
                }
            }

            // ========== 新功能：绑定快捷指令点击事件（增强原有的）==========
            // 异常处理指令（第7个，如果存在的话）已在上方统一处理，此处不再重复绑定
            // 注释掉以避免覆盖原有的输入框填充功能
            /*
            if (commandCards.length >= 7) {
                commandCards[6].addEventListener('click', () => {
                    openExceptionPanel();
                });
            }
            */

            // ========== handleEnhancedFileUpload已经在前面定义，这里删除重复定义 ==========
            // 以下为测试函数
            // ========== 新功能：示例对话触发函数（用于测试）==========
            window.showDocumentUploadDemo = async function() {
                const mockFile = { name: '2025年产假政策.pdf' };
                await handleEnhancedFileUpload([mockFile]);
            };

            window.showSimilarDocDemo = async function() {
                addSystemMessageWithActions(`检测到相似内容！

相似文档：《2024年产假政策》
相似度：92%

主要差异：
• 新增体检医院信息
• 更新银行卡要求`, [
                    { label: '处理', icon: 'cog', action: 'open_conflict_panel', data: {
                        similarDoc: { title: '2024年产假政策', created_at: '2024-11-28 10:00:00' },
                        similarity: 92,
                        differences: ['新增体检医院信息', '更新银行卡要求']
                    }}
                ]);
            };

            window.showCategoryDemo = async function() {
                addSystemMessageWithActions(`文档上传成功！但我不太确定这份文档的分类：

我的猜测（不确定）：
• 公司主体：集团总部（置信度65%）
• 业务领域：员工关系/员工服务

能帮我确认一下吗？`, [
                    { label: '确认分类', icon: 'folder', action: 'open_category_panel', data: {
                        category: { company_entity: '集团总部', business_domain: '员工关系/员工服务' },
                        categoryConfidence: 0.65,
                        tags: ['心理健康', '员工关怀', '咨询服务'],
                        summary: '介绍员工心理健康咨询服务的申请流程'
                    }}
                ]);
            };

            window.showFaqDemo = async function() {
                addSystemMessageWithActions(`从文档中挖掘出 15 条FAQ：
• 自动入库：12 条（高置信度）
• 需要审核：3 条（低置信度或与已有FAQ相似）`, [
                    { label: '审核FAQ', icon: 'question-circle', action: 'open_faq_panel', data: {
                        needReview: [{
                            question: '产假有多少天？',
                            answer: '根据最新政策，产假为158天，包括基本产假98天和延长产假60天。',
                            similar_qa: {
                                question: '产假天数是多少？',
                                answer: '根据2024年政策，产假为128天...'
                            },
                            similarity: 0.95
                        }],
                        autoApproved: []
                    }}
                ]);
            };

            window.showExceptionPanelDemo = function() {
                openExceptionPanel();
            };

            // ========== 批量选择状态管理 ==========
            const batchSelectionState = {
                selectedIds: new Set(),
                lockedType: null,

                reset() {
                    this.selectedIds.clear();
                    this.lockedType = null;
                },

                add(id, type) {
                    if (this.lockedType === null) {
                        this.lockedType = type;
                    }
                    if (type === this.lockedType) {
                        this.selectedIds.add(id);
                        return true;
                    }
                    return false;
                },

                remove(id) {
                    this.selectedIds.delete(id);
                    if (this.selectedIds.size === 0) {
                        this.lockedType = null;
                    }
                },

                getCount() {
                    return this.selectedIds.size;
                },

                getTypeLabel() {
                    switch(this.lockedType) {
                        case 'conflict':
                            return '文档冲突';
                        case 'category':
                            return '待分类';
                        case 'faq':
                            return 'FAQ待审';
                        default:
                            return '';
                    }
                }
            };

            // 绑定复选框事件
            function bindExceptionCheckboxEvents() {
                const checkboxes = document.querySelectorAll('.exception-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const exceptionId = this.getAttribute('data-exception-id');
                        const exceptionType = this.getAttribute('data-exception-type');

                        if (this.checked) {
                            const success = batchSelectionState.add(exceptionId, exceptionType);
                            if (!success) {
                                this.checked = false;
                                alert('只能批量处理相同类型的异常');
                                return;
                            }
                        } else {
                            batchSelectionState.remove(exceptionId);
                        }

                        updateExceptionSelection();
                    });
                });

                // 绑定全选按钮
                const selectAllBtn = document.getElementById('exception-select-all');
                if (selectAllBtn) {
                    selectAllBtn.replaceWith(selectAllBtn.cloneNode(true)); // 移除旧事件
                    document.getElementById('exception-select-all').addEventListener('change', function() {
                        const availableCheckboxes = document.querySelectorAll('.exception-checkbox:not(:disabled)');
                        availableCheckboxes.forEach(checkbox => {
                            checkbox.checked = this.checked;
                            const exceptionId = checkbox.getAttribute('data-exception-id');
                            const exceptionType = checkbox.getAttribute('data-exception-type');

                            if (this.checked) {
                                batchSelectionState.add(exceptionId, exceptionType);
                            } else {
                                batchSelectionState.remove(exceptionId);
                            }
                        });

                        updateExceptionSelection();
                    });
                }

                // 绑定批量处理按钮
                const batchHandleBtn = document.getElementById('exception-batch-handle');
                if (batchHandleBtn) {
                    batchHandleBtn.replaceWith(batchHandleBtn.cloneNode(true));
                    document.getElementById('exception-batch-handle').addEventListener('click', handleExceptionBatchProcess);
                }

                // 绑定批量忽略按钮
                const batchIgnoreBtn = document.getElementById('exception-batch-ignore');
                if (batchIgnoreBtn) {
                    batchIgnoreBtn.replaceWith(batchIgnoreBtn.cloneNode(true));
                    document.getElementById('exception-batch-ignore').addEventListener('click', handleExceptionBatchIgnore);
                }
            }

            function updateExceptionSelection() {
                const count = batchSelectionState.getCount();
                const typeLabel = batchSelectionState.getTypeLabel();

                // 更新计数器
                const countEl = document.getElementById('exception-selected-count');
                if (countEl) {
                    if (typeLabel) {
                        countEl.parentElement.innerHTML = `已选择 <span id="exception-selected-count">${count}</span> 项 (<span class="text-primary">${typeLabel}</span>)`;
                    } else {
                        countEl.textContent = count;
                    }
                }

                // 更新按钮状态
                const batchHandleBtn = document.getElementById('exception-batch-handle');
                const batchIgnoreBtn = document.getElementById('exception-batch-ignore');
                if (batchHandleBtn) batchHandleBtn.disabled = count === 0;
                if (batchIgnoreBtn) batchIgnoreBtn.disabled = count === 0;

                // 更新复选框禁用状态
                if (batchSelectionState.lockedType) {
                    document.querySelectorAll('.exception-checkbox').forEach(cb => {
                        const cbType = cb.getAttribute('data-exception-type');
                        const row = cb.closest('tr');
                        if (cbType !== batchSelectionState.lockedType && !cb.checked) {
                            cb.disabled = true;
                            if (row) row.style.opacity = '0.5';
                            cb.title = '只能批量处理相同类型的异常';
                        }
                    });
                } else {
                    document.querySelectorAll('.exception-checkbox').forEach(cb => {
                        cb.disabled = false;
                        const row = cb.closest('tr');
                        if (row) row.style.opacity = '1';
                        cb.title = '';
                    });
                }

                // 更新全选按钮
                const selectAllCheckbox = document.getElementById('exception-select-all');
                if (selectAllCheckbox) {
                    const allCheckboxes = Array.from(document.querySelectorAll('.exception-checkbox:not(:disabled)'));
                    const checkedCheckboxes = allCheckboxes.filter(cb => cb.checked);
                    selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
                }
            }

            // 获取已选异常的数据
            function getSelectedExceptionsData() {
                const selectedIds = Array.from(batchSelectionState.selectedIds);
                const exceptions = [];

                selectedIds.forEach(id => {
                    const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${id}"]`);
                    if (checkbox) {
                        const row = checkbox.closest('tr');
                        const titleEl = row.querySelector('td:nth-child(2) span');
                        const title = titleEl ? titleEl.textContent : '';
                        exceptions.push({
                            id: id,
                            type: batchSelectionState.lockedType,
                            title: title
                        });
                    }
                });

                return exceptions;
            }

            // 批量处理主逻辑
            function handleExceptionBatchProcess() {
                const selectedIds = Array.from(batchSelectionState.selectedIds);
                if (selectedIds.length === 0) {
                    alert('请先选择要处理的异常');
                    return;
                }

                const exceptionType = batchSelectionState.lockedType;
                const exceptions = getSelectedExceptionsData();

                switch(exceptionType) {
                    case 'conflict':
                        showConflictBatchDialog(exceptions);
                        break;
                    case 'category':
                        showCategoryBatchDialog(exceptions);
                        break;
                    case 'faq':
                        showFaqBatchDialog(exceptions);
                        break;
                    default:
                        alert('未知的异常类型');
                }
            }

            // 批量忽略
            function handleExceptionBatchIgnore() {
                const count = batchSelectionState.getCount();
                const typeLabel = batchSelectionState.getTypeLabel();

                if (confirm(`确认忽略这 ${count} 个${typeLabel}异常吗？\n\n忽略后这些异常将不再显示。`)) {
                    const selectedIds = Array.from(batchSelectionState.selectedIds);
                    selectedIds.forEach(id => {
                        const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${id}"]`);
                        if (checkbox) {
                            const row = checkbox.closest('tr');
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    });

                    addSystemMessage(`已忽略 ${count} 个${typeLabel}异常`);
                    batchSelectionState.reset();
                    updateExceptionSelection();
                }
            }

            // 批量处理对话框管理
            function showBatchDialog(title, content, onConfirm) {
                const dialog = document.getElementById('batch-dialog');
                const overlay = document.getElementById('batch-dialog-overlay');
                const titleEl = document.getElementById('batch-dialog-title');
                const contentEl = document.getElementById('batch-dialog-content');
                const confirmBtn = document.getElementById('batch-dialog-confirm');
                const cancelBtn = document.getElementById('batch-dialog-cancel');

                titleEl.textContent = title;
                contentEl.innerHTML = content;

                dialog.classList.remove('hidden');
                overlay.classList.remove('hidden');

                const closeDialog = () => {
                    dialog.classList.add('hidden');
                    overlay.classList.add('hidden');
                };

                // 移除旧事件监听器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                document.getElementById('batch-dialog-confirm').addEventListener('click', () => {
                    onConfirm();
                    closeDialog();
                });

                document.getElementById('batch-dialog-cancel').addEventListener('click', closeDialog);
                overlay.addEventListener('click', closeDialog, { once: true });
            }

            // 文档冲突批量处理对话框
            function showConflictBatchDialog(exceptions) {
                const count = exceptions.length;
                const content = `
                    <div class="space-y-4">
                        <p class="text-sm text-text-secondary">已选择 ${count} 个文档冲突，请选择批量处理方式：</p>

                        <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                            <ul class="text-sm text-text-secondary space-y-1">
                                ${exceptions.map(ex => `<li>• ${ex.title}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="space-y-2">
                            <label class="flex items-center p-3 border border-border-light rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="conflict-action" value="replace" class="mr-3" checked>
                                <div>
                                    <div class="font-medium text-text-primary">批量覆盖为新版本</div>
                                    <div class="text-xs text-text-secondary">所有新文档将覆盖旧版本</div>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border border-border-light rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="conflict-action" value="keep_both" class="mr-3">
                                <div>
                                    <div class="font-medium text-text-primary">批量保留两个版本</div>
                                    <div class="text-xs text-text-secondary">为新文档自动添加版本号后缀</div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;

                showBatchDialog('批量处理文档冲突', content, () => {
                    const selectedAction = document.querySelector('input[name="conflict-action"]:checked')?.value;
                    if (selectedAction) {
                        executeBatchConflictAction(selectedAction, exceptions);
                    }
                });
            }

            function executeBatchConflictAction(action, exceptions) {
                const count = exceptions.length;
                const actionLabels = {
                    'replace': '覆盖为新版本',
                    'keep_both': '保留两个版本'
                };

                addSystemMessage(`正在批量处理 ${count} 个文档冲突...`);

                setTimeout(() => {
                    exceptions.forEach(ex => {
                        const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${ex.id}"]`);
                        if (checkbox) {
                            const row = checkbox.closest('tr');
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    });

                    addSystemMessage(`批量处理成功：已${actionLabels[action]} ${count} 个文档`);
                    batchSelectionState.reset();
                    updateExceptionSelection();
                }, 1000);
            }

            // 待分类批量处理对话框
            function showCategoryBatchDialog(exceptions) {
                const count = exceptions.length;
                const content = `
                    <div class="space-y-4">
                        <p class="text-sm text-text-secondary">已选择 ${count} 个待分类项目，请选择统一的分类：</p>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">公司主体</label>
                            <select id="batch-company-entity" class="input-primary">
                                <option value="集团总部">集团总部</option>
                                <option value="分公司A">分公司A</option>
                                <option value="分公司B">分公司B</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">业务领域</label>
                            <select id="batch-business-domain" class="input-primary">
                                <option value="入转调离/入职服务">入转调离/入职服务</option>
                                <option value="员工福利/假期管理">员工福利/假期管理</option>
                                <option value="员工关系/员工服务">员工关系/员工服务</option>
                                <option value="培训发展">培训发展</option>
                                <option value="招聘管理">招聘管理</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">标签(可选)</label>
                            <input type="text" id="batch-tags" class="input-primary" placeholder="多个标签用逗号分隔">
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-blue-800">
                                <i class="fa fa-info-circle mr-1"></i>
                                该分类将应用到所有选中的文档
                            </p>
                        </div>
                    </div>
                `;

                showBatchDialog('批量分类', content, () => {
                    const companyEntity = document.getElementById('batch-company-entity')?.value;
                    const businessDomain = document.getElementById('batch-business-domain')?.value;
                    const tags = document.getElementById('batch-tags')?.value;

                    const categoryData = {
                        company_entity: companyEntity,
                        business_domain: businessDomain,
                        tags: tags ? tags.split(',').map(t => t.trim()) : []
                    };

                    executeBatchCategoryAction(categoryData, exceptions);
                });
            }

            function executeBatchCategoryAction(categoryData, exceptions) {
                const count = exceptions.length;

                addSystemMessage(`正在为 ${count} 个文档应用分类...`);

                setTimeout(() => {
                    exceptions.forEach(ex => {
                        const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${ex.id}"]`);
                        if (checkbox) {
                            const row = checkbox.closest('tr');
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    });

                    addSystemMessage(`批量分类成功：已为 ${count} 个文档应用分类\n公司主体: ${categoryData.company_entity}\n业务领域: ${categoryData.business_domain}`);
                    batchSelectionState.reset();
                    updateExceptionSelection();
                }, 1000);
            }

            // FAQ批量处理对话框
            function showFaqBatchDialog(exceptions) {
                const count = exceptions.length;
                const content = `
                    <div class="space-y-4">
                        <p class="text-sm text-text-secondary">已选择 ${count} 条FAQ待审，请选择批量操作：</p>

                        <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                            <ul class="text-sm text-text-secondary space-y-1">
                                ${exceptions.map(ex => `<li>• ${ex.title}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="space-y-2">
                            <label class="flex items-center p-3 border border-border-light rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="faq-action" value="approve" class="mr-3" checked>
                                <div>
                                    <div class="font-medium text-text-primary">批量批准发布</div>
                                    <div class="text-xs text-text-secondary">所有FAQ将发布到知识库</div>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border border-border-light rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="faq-action" value="reject" class="mr-3">
                                <div>
                                    <div class="font-medium text-text-primary">批量驳回</div>
                                    <div class="text-xs text-text-secondary">需要填写驳回原因</div>
                                </div>
                            </label>

                            <label class="flex items-center p-3 border border-border-light rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="faq-action" value="delay" class="mr-3">
                                <div>
                                    <div class="font-medium text-text-primary">批量延期审核</div>
                                    <div class="text-xs text-text-secondary">稍后再处理</div>
                                </div>
                            </label>
                        </div>

                        <div id="reject-reason-container" class="hidden">
                            <label class="block text-sm font-medium text-text-secondary mb-2">驳回原因</label>
                            <textarea id="batch-reject-reason" class="input-primary" rows="3" placeholder="请输入驳回原因..."></textarea>
                        </div>
                    </div>
                `;

                showBatchDialog('批量处理FAQ', content, () => {
                    const selectedAction = document.querySelector('input[name="faq-action"]:checked')?.value;
                    const rejectReason = document.getElementById('batch-reject-reason')?.value;

                    if (selectedAction === 'reject' && !rejectReason) {
                        alert('请输入驳回原因');
                        return;
                    }

                    executeBatchFaqAction(selectedAction, exceptions, rejectReason);
                });

                // 监听单选按钮变化
                setTimeout(() => {
                    const radioButtons = document.querySelectorAll('input[name="faq-action"]');
                    const reasonContainer = document.getElementById('reject-reason-container');

                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', function() {
                            if (this.value === 'reject') {
                                reasonContainer.classList.remove('hidden');
                            } else {
                                reasonContainer.classList.add('hidden');
                            }
                        });
                    });
                }, 100);
            }

            function executeBatchFaqAction(action, exceptions, reason = '') {
                const count = exceptions.length;
                const actionLabels = {
                    'approve': '批准发布',
                    'reject': '驳回',
                    'delay': '延期审核'
                };

                addSystemMessage(`正在批量${actionLabels[action]} ${count} 条FAQ...`);

                setTimeout(() => {
                    exceptions.forEach(ex => {
                        const checkbox = document.querySelector(`.exception-checkbox[data-exception-id="${ex.id}"]`);
                        if (checkbox) {
                            const row = checkbox.closest('tr');
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);
                        }
                    });

                    let message = `批量处理成功：已${actionLabels[action]} ${count} 条FAQ`;
                    if (action === 'reject' && reason) {
                        message += `\n驳回原因: ${reason}`;
                    }

                    addSystemMessage(message);
                    batchSelectionState.reset();
                    updateExceptionSelection();
                }, 1000);
            }

            // ========== 知识管理面板JavaScript ==========

            // 模拟知识体系数据存储 (支持多层级嵌套结构)
            let knowledgeCategories = [
                {
                    id: 'policy',
                    name: '战略与制度',
                    icon: 'folder',
                    color: 'teal',
                    definition: 'HR治理、制度与风险的顶层规则，确保跨地域、跨业务的一致性与合规性。',
                    classification: '按治理主题拆分：政策治理、合规风险、数据安全。',
                    children: [
                        {
                            id: 'policy-governance',
                            name: 'HR政策与治理',
                            icon: 'folder',
                            color: 'teal',
                            definition: '定义HR政策框架、角色职责及发布节奏。',
                            classification: '政策总则、职责权限、版本发布。',
                            children: [
                                { id: 'policy-handbook', name: '政策总则与术语', icon: 'file-text-o', color: 'blue', definition: 'HR政策手册、术语释义与适用范围。', classification: '总则/适用范围/术语' },
                                { id: 'policy-roles', name: '职责与权限矩阵', icon: 'file-text-o', color: 'blue', definition: 'HR、业务、外包方在流程中的责任划分。', classification: '职责分工/授权/升级路径' },
                                { id: 'policy-version', name: '版本管理与公告', icon: 'file-text-o', color: 'blue', definition: '政策版本、发布日期及变更记录。', classification: '版本号/发布渠道/生效与废止' }
                            ]
                        },
                        {
                            id: 'policy-compliance',
                            name: '合规与风险',
                            icon: 'folder',
                            color: 'yellow',
                            definition: '确保用工合法、审计可追溯、纠纷可控。',
                            classification: '法律合规、审计整改、外部监管要求。',
                            children: [
                                { id: 'policy-labor', name: '劳动法规与合同模板', icon: 'file-text-o', color: 'yellow', definition: '劳动法适用、区域差异、标准合同与附件。', classification: '法规口径/模板/区域差异' },
                                { id: 'policy-audit', name: '合规稽核与整改', icon: 'file-text-o', color: 'yellow', definition: '内外部审计检查项、整改闭环与证据。', classification: '检查项/缺陷跟踪/复核' },
                                { id: 'policy-dispute', name: '纠纷与仲裁预案', icon: 'file-text-o', color: 'yellow', definition: '劳动争议应对、谈判话术与材料清单。', classification: '争议类型/材料/风险判定' }
                            ]
                        },
                        {
                            id: 'policy-security',
                            name: '数据安全与隐私',
                            icon: 'folder',
                            color: 'gray',
                            definition: '员工数据采集、存储、共享与留存的安全规范。',
                            classification: '数据采集、存储访问、脱敏与留存周期。',
                            children: [
                                { id: 'policy-privacy', name: '个人信息与同意', icon: 'file-text-o', color: 'gray', definition: '员工隐私告知、同意书及撤回机制。', classification: '告知/同意/撤回' },
                                { id: 'policy-access', name: '访问与最小权限', icon: 'file-text-o', color: 'gray', definition: '访问分级、审批、日志与异常监控。', classification: '分级/审批/监控' },
                                { id: 'policy-retention', name: '留存与销毁', icon: 'file-text-o', color: 'gray', definition: '数据留存期限、存档标准与销毁流程。', classification: '留存期限/归档/销毁' }
                            ]
                        }
                    ]
                },
                {
                    id: 'org',
                    name: '组织与岗位',
                    icon: 'folder',
                    color: 'blue',
                    definition: '组织设计、编制与岗位体系，支撑业务结构与人岗匹配。',
                    classification: '按组织规划、岗位体系、流程权限划分。',
                    children: [
                        {
                            id: 'org-planning',
                            name: '组织与编制',
                            icon: 'folder',
                            color: 'blue',
                            definition: '组织架构、HC计划与预算对齐。',
                            classification: '编制计划、预算核定、变更治理。',
                            children: [
                                { id: 'org-headcount', name: '年度编制与HC计划', icon: 'file-text-o', color: 'blue', definition: '年度HC拆解、补位策略与冻结规则。', classification: '计划/补位/冻结' },
                                { id: 'org-structure', name: '组织架构与变更', icon: 'file-text-o', color: 'blue', definition: '架构设计、汇报关系与变更审批链路。', classification: '设计原则/变更审批/沟通' },
                                { id: 'org-budget', name: '预算与成本分摊', icon: 'file-text-o', color: 'blue', definition: '人力成本口径、分摊规则与追踪。', classification: '成本口径/分摊/追踪' }
                            ]
                        },
                        {
                            id: 'org-job',
                            name: '岗位与职级',
                            icon: 'folder',
                            color: 'indigo',
                            definition: '岗位说明书、职级体系与任职资格定义。',
                            classification: '岗位标准、职级与晋升、资质与评审。',
                            children: [
                                { id: 'org-jd', name: '岗位说明书', icon: 'file-text-o', color: 'indigo', definition: '岗位职责、任职要求与关键指标。', classification: '职责/能力/指标' },
                                { id: 'org-level', name: '职级体系与晋升', icon: 'file-text-o', color: 'indigo', definition: '职级梯队、晋升节奏、评审标准。', classification: '职级映射/晋升周期/评审口径' },
                                { id: 'org-qualification', name: '任职资格与认证', icon: 'file-text-o', color: 'indigo', definition: '专业资格、技能认证与复评。', classification: '资格定义/取证/复评' }
                            ]
                        },
                        {
                            id: 'org-workflow',
                            name: '流程与权限',
                            icon: 'folder',
                            color: 'cyan',
                            definition: 'HR主数据、审批流与系统权限管理。',
                            classification: '流程分级、权限模型、主数据口径。',
                            children: [
                                { id: 'org-approval', name: '审批链路与SLA', icon: 'file-text-o', color: 'cyan', definition: '跨部门审批节点、SLA与升级规则。', classification: '节点/时效/升级' },
                                { id: 'org-masterdata', name: '主数据口径', icon: 'file-text-o', color: 'cyan', definition: '人事字段定义、编码规则与变更留痕。', classification: '字段/编码/留痕' }
                            ]
                        }
                    ]
                },
                {
                    id: 'talent',
                    name: '招聘与入职',
                    icon: 'folder',
                    color: 'green',
                    definition: '面向人才获取与转化的全链路标准化。',
                    classification: '按策略渠道、流程执行、入职承接分层。',
                    children: [
                        {
                            id: 'talent-strategy',
                            name: '招聘策略与渠道',
                            icon: 'folder',
                            color: 'green',
                            definition: '需求拆解、预算与渠道组合。',
                            classification: '需求计划、渠道与供应商、雇主品牌。',
                            children: [
                                { id: 'talent-plan', name: '招聘需求与预算', icon: 'file-text-o', color: 'green', definition: 'HC需求、优先级与预算控制。', classification: '需求拆解/优先级/预算' },
                                { id: 'talent-channel', name: '渠道与供应商', icon: 'file-text-o', color: 'green', definition: '直招、外包、猎头与绩效评估。', classification: '渠道组合/供方管理/评估' },
                                { id: 'talent-brand', name: '雇主品牌与校招', icon: 'file-text-o', color: 'green', definition: '雇主品牌资产、校招项目与宣讲物料。', classification: '品牌素材/校招流程/触点' }
                            ]
                        },
                        {
                            id: 'talent-execution',
                            name: '招聘流程',
                            icon: 'folder',
                            color: 'emerald',
                            definition: '从JD发布到offer签署的作业标准。',
                            classification: 'JD与渠道、评估、offer与背调。',
                            children: [
                                { id: 'talent-jd-release', name: 'JD发布与管理', icon: 'file-text-o', color: 'emerald', definition: 'JD模板、发布规范与更新节奏。', classification: '模板/发布/更新' },
                                { id: 'talent-interview', name: '面试评估与评分卡', icon: 'file-text-o', color: 'emerald', definition: '面试流程、题库与评分标准。', classification: '流程/题库/评分卡' },
                                { id: 'talent-offer', name: 'offer审批与发放', icon: 'file-text-o', color: 'emerald', definition: '薪酬对标、审批链、offer发放与保存。', classification: '对标/审批/留存' },
                                { id: 'talent-background', name: '背景调查与体检', icon: 'file-text-o', color: 'emerald', definition: '背调分级、供应商SLA、体检项目与豁免。', classification: '分级/SLA/豁免' }
                            ]
                        },
                        {
                            id: 'talent-onboarding',
                            name: '入职管理',
                            icon: 'folder',
                            color: 'lime',
                            definition: 'offer转化后的入职体验与合规闭环。',
                            classification: '入职前准备、首日报到、试用期管理。',
                            children: [
                                { id: 'onboarding-prep', name: '入职准备', icon: 'file-text-o', color: 'lime', definition: '资料收集、工位/设备准备、账户申请。', classification: '材料/设备/账户' },
                                { id: 'onboarding-day1', name: '报到与首日体验', icon: 'file-text-o', color: 'lime', definition: '报到指引、迎新、合规签署与培训。', classification: '报到/签署/迎新' },
                                { id: 'onboarding-probation', name: '试用期管理', icon: 'file-text-o', color: 'lime', definition: '试用期目标、转正评估与风险预警。', classification: '目标/评估/预警' }
                            ]
                        }
                    ]
                },
                {
                    id: 'operation',
                    name: '在职运营与员工关系',
                    icon: 'folder',
                    color: 'orange',
                    definition: '围绕在职员工的人事合同、考勤假勤与关系维护。',
                    classification: '合同与变更、考勤假期、员工关系与沟通。',
                    children: [
                        {
                            id: 'operation-contract',
                            name: '劳动合同与人事变更',
                            icon: 'folder',
                            color: 'orange',
                            definition: '合同签订续签、调岗调薪调级与派遣管理。',
                            classification: '合同/变更/派遣外包。',
                            children: [
                                { id: 'operation-contracting', name: '签订/续签/变更', icon: 'file-text-o', color: 'orange', definition: '合同模板、续签提醒与变更审批。', classification: '模板/提醒/审批' },
                                { id: 'operation-transfer', name: '调岗调薪调级', icon: 'file-text-o', color: 'orange', definition: '调动类型、审批口径与生效规则。', classification: '类型/口径/生效' },
                                { id: 'operation-secondment', name: '派遣与外包', icon: 'file-text-o', color: 'orange', definition: '派遣/外包用工管理与合规要求。', classification: '用工类型/合同/监管' }
                            ]
                        },
                        {
                            id: 'operation-attendance',
                            name: '考勤与假期',
                            icon: 'folder',
                            color: 'amber',
                            definition: '假勤政策、排班规则与异常处理。',
                            classification: '假期口径、加班与调休、异常纠偏。',
                            children: [
                                { id: 'operation-leave', name: '假期政策与申请', icon: 'file-text-o', color: 'amber', definition: '假期类型、额度、申请与审批流。', classification: '类型/额度/流程' },
                                { id: 'operation-overtime', name: '加班与调休', icon: 'file-text-o', color: 'amber', definition: '加班申请、调休抵扣与工资结算。', classification: '申请/抵扣/结算' },
                                { id: 'operation-attendance-exception', name: '考勤异常处理', icon: 'file-text-o', color: 'amber', definition: '漏打卡、异常工时与纠错流程。', classification: '异常分类/证明/纠错' }
                            ]
                        },
                        {
                            id: 'operation-relationship',
                            name: '员工关系与沟通',
                            icon: 'folder',
                            color: 'red',
                            definition: '员工沟通、关怀计划与纪律处分机制。',
                            classification: '沟通与关怀、申诉与仲裁、纪律处分。',
                            children: [
                                { id: 'operation-engagement', name: '沟通与关怀', icon: 'file-text-o', color: 'red', definition: '员工关怀、活动与情绪预警。', classification: '关怀/活动/预警' },
                                { id: 'operation-grievance', name: '申诉与投诉处理', icon: 'file-text-o', color: 'red', definition: '申诉入口、调查流程与输出。', classification: '入口/调查/结论' },
                                { id: 'operation-discipline', name: '纪律处分与争议', icon: 'file-text-o', color: 'red', definition: '违规判定、处分级别与法律风险。', classification: '判定/级别/风险' }
                            ]
                        }
                    ]
                },
                {
                    id: 'reward',
                    name: '薪酬福利与激励',
                    icon: 'folder',
                    color: 'purple',
                    definition: '薪酬、福利、长期激励的设计与落地。',
                    classification: '薪酬核算、福利保障、激励机制。',
                    children: [
                        {
                            id: 'reward-payroll',
                            name: '薪酬发放与核算',
                            icon: 'folder',
                            color: 'purple',
                            definition: '薪酬结构、薪资核算、个税与社保。',
                            classification: '结构口径、核算发放、税社保申报。',
                            children: [
                                { id: 'reward-structure', name: '薪酬结构与带宽', icon: 'file-text-o', color: 'purple', definition: '薪级薪档、市场对标与带宽控制。', classification: '档级/对标/带宽' },
                                { id: 'reward-payrun', name: '薪资核算与发放', icon: 'file-text-o', color: 'purple', definition: '薪资周期、校验点与发薪SLA。', classification: '周期/校验/SLA' },
                                { id: 'reward-tax', name: '个税与社保申报', icon: 'file-text-o', color: 'purple', definition: '申报流程、基数口径与异常处理。', classification: '申报/基数/异常' }
                            ]
                        },
                        {
                            id: 'reward-benefit',
                            name: '福利与保障',
                            icon: 'folder',
                            color: 'pink',
                            definition: '社保公积金、商业保险、假期与补贴。',
                            classification: '强制福利、自选福利、假期补贴。',
                            children: [
                                { id: 'reward-social', name: '社保与公积金', icon: 'file-text-o', color: 'pink', definition: '参保规则、基数、转移与补缴。', classification: '参保/基数/转移补缴' },
                                { id: 'reward-insurance', name: '商业保险', icon: 'file-text-o', color: 'pink', definition: '投保方案、理赔流程与供应商管理。', classification: '方案/理赔/供方' },
                                { id: 'reward-leave', name: '带薪假期与补贴', icon: 'file-text-o', color: 'pink', definition: '年假、病假、福利补贴与适用条件。', classification: '假期口径/补贴/适用' }
                            ]
                        },
                        {
                            id: 'reward-incentive',
                            name: '激励机制',
                            icon: 'folder',
                            color: 'violet',
                            definition: '短期奖金与长期激励的设计与执行。',
                            classification: '奖金分配、股权/长期激励、认可计划。',
                            children: [
                                { id: 'reward-bonus', name: '奖金激励与分配', icon: 'file-text-o', color: 'violet', definition: '奖金池测算、分配口径与发放节奏。', classification: '测算/口径/节奏' },
                                { id: 'reward-equity', name: '长期激励/股权', icon: 'file-text-o', color: 'violet', definition: '股权计划、归属条件与税务处理。', classification: '计划/归属/税务' },
                                { id: 'reward-recognition', name: '认可与非金激励', icon: 'file-text-o', color: 'violet', definition: '即时认可、荣誉体系与预算管理。', classification: '形式/预算/频次' }
                            ]
                        }
                    ]
                },
                {
                    id: 'performance',
                    name: '绩效与发展',
                    icon: 'folder',
                    color: 'cyan',
                    definition: '绩效闭环与员工发展路径的能力建设。',
                    classification: '绩效管理、培训学习、职业发展。',
                    children: [
                        {
                            id: 'performance-management',
                            name: '绩效管理',
                            icon: 'folder',
                            color: 'cyan',
                            definition: '目标制定、评估校准、反馈改进。',
                            classification: '目标对齐、评估校准、反馈辅导。',
                            children: [
                                { id: 'performance-goal', name: '目标制定与对齐', icon: 'file-text-o', color: 'cyan', definition: 'OKR/KPI口径、拆解方法与对齐节奏。', classification: '口径/拆解/节奏' },
                                { id: 'performance-review', name: '周期评估与校准', icon: 'file-text-o', color: 'cyan', definition: '评估周期、校准会与争议处理。', classification: '周期/校准/争议' },
                                { id: 'performance-feedback', name: '反馈与改进', icon: 'file-text-o', color: 'cyan', definition: '绩效面谈、辅导计划与改进跟踪。', classification: '面谈/辅导/跟踪' }
                            ]
                        },
                        {
                            id: 'performance-learning',
                            name: '培训与学习',
                            icon: 'folder',
                            color: 'sky',
                            definition: '学习体系、资源与效果评估。',
                            classification: '体系与课程、学习资源、效果评估。',
                            children: [
                                { id: 'learning-system', name: '培训体系与课程库', icon: 'file-text-o', color: 'sky', definition: '能力模型、课程地图与人群分层。', classification: '模型/地图/分层' },
                                { id: 'learning-delivery', name: '学习资源与工具', icon: 'file-text-o', color: 'sky', definition: '线上线下资源、平台与学习路径。', classification: '资源/平台/路径' },
                                { id: 'learning-evaluation', name: '培训效果评估', icon: 'file-text-o', color: 'sky', definition: '满意度、学以致用与业务指标验证。', classification: '满意度/应用/指标' }
                            ]
                        },
                        {
                            id: 'performance-career',
                            name: '职业发展与继任',
                            icon: 'folder',
                    color: 'sky',
                            definition: '职业双通道、继任计划与内部流动。',
                            classification: '职业路径、继任盘点、流动与轮岗。',
                            children: [
                                { id: 'career-path', name: '职业路径与双通道', icon: 'file-text-o', color: 'sky', definition: '专业/管理双通道与成长里程碑。', classification: '通道/里程碑/标准' },
                                { id: 'career-succession', name: '继任计划与盘点', icon: 'file-text-o', color: 'sky', definition: '关键岗位继任梯队、风险与行动计划。', classification: '关键岗位/梯队/行动' },
                                { id: 'career-mobility', name: '内部流动与轮岗', icon: 'file-text-o', color: 'sky', definition: '内推、内部招聘、轮岗与体验营。', classification: '渠道/规则/体验' }
                            ]
                        }
                    ]
                },
                {
                    id: 'offboarding',
                    name: '离职与交接',
                    icon: 'folder',
                    color: 'stone',
                    definition: '离职流程、补偿风险与知识资产交接。',
                    classification: '离职办理、交接回收、离职后管理。',
                    children: [
                        {
                            id: 'offboarding-process',
                            name: '离职办理',
                            icon: 'folder',
                            color: 'stone',
                            definition: '主动与被动离职的作业标准与合规审查。',
                            classification: '离职类型、审批与风控、补偿口径。',
                            children: [
                                { id: 'offboarding-voluntary', name: '主动离职流程', icon: 'file-text-o', color: 'stone', definition: '申请、面谈、交接与离职证明。', classification: '申请/面谈/证明' },
                                { id: 'offboarding-involuntary', name: '解聘/裁员流程', icon: 'file-text-o', color: 'stone', definition: '解聘情形、风险评估与法律必备材料。', classification: '情形/评估/材料' },
                                { id: 'offboarding-compensation', name: '补偿与风险控制', icon: 'file-text-o', color: 'stone', definition: '补偿计算、谈判要点与合规留痕。', classification: '计算/谈判/留痕' }
                            ]
                        },
                        {
                            id: 'offboarding-handover',
                            name: '交接与资产回收',
                            icon: 'folder',
                            color: 'amber',
                            definition: '知识、客户、设备与权限的闭环回收。',
                            classification: '知识交接、资产回收、权限关闭。',
                            children: [
                                { id: 'offboarding-knowledge', name: '知识与客户交接', icon: 'file-text-o', color: 'amber', definition: '工作移交清单、客户/项目交接与文档沉淀。', classification: '清单/客户项目/沉淀' },
                                { id: 'offboarding-assets', name: '设备资产回收', icon: 'file-text-o', color: 'amber', definition: '设备回收、工牌/钥匙与库存登记。', classification: '设备/物理资产/登记' },
                                { id: 'offboarding-access', name: '权限关闭与保留', icon: 'file-text-o', color: 'amber', definition: '系统权限、邮箱与数据保留口径。', classification: '权限/邮箱/留存' }
                            ]
                        },
                        {
                            id: 'offboarding-post',
                            name: '离职后管理',
                            icon: 'folder',
                            color: 'orange',
                            definition: '离职洞察、校友网络与返聘机制。',
                            classification: '离职访谈、数据分析、校友与返聘。',
                            children: [
                                { id: 'offboarding-exit-interview', name: '离职访谈与洞察', icon: 'file-text-o', color: 'orange', definition: '离职访谈题纲、根因分析与改进行动。', classification: '访谈/根因/改进' },
                                { id: 'offboarding-alumni', name: '校友网络与返聘', icon: 'file-text-o', color: 'orange', definition: '校友社群、返聘流程与品牌维护。', classification: '社群/返聘/品牌' }
                            ]
                        }
                    ]
                },
                {
                    id: 'knowledgeops',
                    name: '知识运营与工具',
                    icon: 'folder',
                    color: 'teal',
                    definition: '支撑知识库持续演进的分类标准、质量与工具。',
                    classification: '治理、质量、工具与数据三个维度。',
                    children: [
                        {
                            id: 'knowledge-governance',
                            name: '分类标准与治理',
                            icon: 'folder',
                            color: 'teal',
                            definition: '分类模型、版本与角色治理。',
                            classification: '分类模型、角色责任、变更管理。',
                            children: [
                                { id: 'knowledge-model', name: '分类模型与版本', icon: 'file-text-o', color: 'teal', definition: '分类原则、节点命名、版本变更记录。', classification: '原则/命名/版本' },
                                { id: 'knowledge-role', name: '责任人矩阵', icon: 'file-text-o', color: 'teal', definition: '维护人、审核人、发布人及SLA。', classification: '角色/职责/SLA' },
                                { id: 'knowledge-change', name: '变更与审计', icon: 'file-text-o', color: 'teal', definition: '节点新增/删除/移动的审批与审计日志。', classification: '新增删除移动/审批/审计' }
                            ]
                        },
                        {
                            id: 'knowledge-quality',
                            name: '知识质量',
                            icon: 'folder',
                            color: 'emerald',
                            definition: '评审、有效期、敏感信息治理。',
                            classification: '评审与发布、有效期与归档、敏感信息。',
                            children: [
                                { id: 'knowledge-review', name: '评审与发布规则', icon: 'file-text-o', color: 'emerald', definition: '评审清单、发布准入与纠错通道。', classification: '清单/准入/纠错' },
                                { id: 'knowledge-archive', name: '有效期与归档', icon: 'file-text-o', color: 'emerald', definition: '过期提醒、更新节奏与归档策略。', classification: '提醒/更新/归档' },
                                { id: 'knowledge-sensitive', name: '敏感信息与脱敏', icon: 'file-text-o', color: 'emerald', definition: '敏感字段、脱敏规则与水印留痕。', classification: '字段/脱敏/留痕' }
                            ]
                        },
                        {
                            id: 'knowledge-tooling',
                            name: '工具与数据',
                            icon: 'folder',
                            color: 'blue',
                            definition: '知识生产与检索工具、标签体系与数据监控。',
                            classification: 'FAQ与检索、标签元数据、数据看板。',
                            children: [
                                { id: 'knowledge-faq', name: 'FAQ体系与检索', icon: 'file-text-o', color: 'blue', definition: 'FAQ分层、泛化策略与检索规则。', classification: '分层/泛化/检索' },
                                { id: 'knowledge-tag', name: '标签与元数据', icon: 'file-text-o', color: 'blue', definition: '标签规范、自动打标与关联关系。', classification: '规范/自动化/关联' },
                                { id: 'knowledge-dashboard', name: '数据看板与监控', icon: 'file-text-o', color: 'blue', definition: '利用率、缺口、反馈与改进闭环。', classification: '利用率/缺口/反馈' }
                            ]
                        }
                    ]
                }
            ];

            // 知识树状态（多层级支持）
            let expandedNodes = new Set();
            let activeKnowledgeNodeId = 'all';

            // 统计分类总数（含多级）
            function countCategories(categories = []) {
                return categories.reduce((acc, cat) => acc + 1 + countCategories(cat.children || []), 0);
            }

            // 查找分类节点并返回路径
            function findCategoryNode(categories, targetId, path = []) {
                for (const cat of categories) {
                    if (cat.id === targetId) {
                        return { node: cat, path };
                    }
                    if (cat.children && cat.children.length > 0) {
                        const found = findCategoryNode(cat.children, targetId, [...path, cat.id]);
                        if (found) return found;
                    }
                }
                return null;
            }

            // 收集节点及其所有子节点ID
            function collectCategoryIds(category, bucket = []) {
                bucket.push(category.id);
                (category.children || []).forEach(child => collectCategoryIds(child, bucket));
                return bucket;
            }

            // 确保选中节点的祖先展开，方便定位多级节点
            function ensureAncestorsExpanded(nodeId) {
                const result = findCategoryNode(knowledgeCategories, nodeId);
                if (result) {
                    result.path.forEach(pid => expandedNodes.add(pid));
                }
            }

            // 根节点元信息，便于在UI中呈现定义与分类标准
            const rootNodeMeta = {
                id: 'all',
                name: '全部知识',
                definition: 'HRSSC知识全景，覆盖战略与制度、组织岗位、招聘入职、在职运营、薪酬福利、绩效发展、离职交接与知识运营八大域。',
                classification: '顶层按主题域分层；中层按业务流程与能力拆解；底层按作业场景与资源类型（政策/流程/模板/FAQ/案例/工具）区分，保证MECE、可扩展、可演进。'
            };

            // 获取节点路径名称（用于面包屑与元信息展示）
            function getNodePathNames(nodeId, fallbackName = '') {
                if (nodeId === 'all') return ['全部知识'];
                const found = findCategoryNode(knowledgeCategories, nodeId);
                if (!found) return ['全部知识', fallbackName || nodeId];

                const names = ['全部知识'];
                found.path.forEach(pid => {
                    const parentNode = findCategoryNode(knowledgeCategories, pid);
                    if (parentNode?.node?.name) {
                        names.push(parentNode.node.name);
                    }
                });
                names.push(found.node.name);
                return names;
            }

            // 聚合节点元信息：定义、分类标准、路径与子节点统计
            function getNodeMeta(nodeId, fallbackName = '') {
                if (nodeId === 'all') {
                    return {
                        ...rootNodeMeta,
                        path: ['全部知识'],
                        children: knowledgeCategories.length,
                        descendants: countCategories(knowledgeCategories)
                    };
                }

                const found = findCategoryNode(knowledgeCategories, nodeId);
                if (!found) return null;

                const node = found.node;
                return {
                    id: node.id,
                    name: node.name || fallbackName,
                    definition: node.definition || '待补充定义',
                    classification: node.classification || '分类标准待补充',
                    path: getNodePathNames(nodeId, fallbackName),
                    children: node.children ? node.children.length : 0,
                    descendants: countCategories(node.children || [])
                };
            }

            // 在右侧面板展示节点元信息，帮助用户理解分类意义
            function renderNodeMeta(nodeId, nodeName = '') {
                const panel = document.getElementById('node-meta-panel');
                if (!panel) return;

                const meta = getNodeMeta(nodeId, nodeName);
                if (!meta) {
                    panel.classList.add('hidden');
                    return;
                }

                panel.classList.remove('hidden');
                const pathText = meta.path ? meta.path.join(' / ') : (nodeName || '全部知识');
                panel.innerHTML = `
                    <div class="bg-white shadow-card rounded-lg p-4 border border-gray-100 col-span-2">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs font-semibold text-teal-600 uppercase tracking-wide">节点定义</div>
                            <div class="text-[11px] text-gray-500">ID: ${meta.id}</div>
                        </div>
                        <p class="text-sm text-text-primary leading-relaxed">${meta.definition}</p>
                    </div>
                    <div class="bg-white shadow-card rounded-lg p-4 border border-gray-100">
                        <div class="text-xs font-semibold text-teal-600 uppercase tracking-wide mb-1">分类标准</div>
                        <p class="text-sm text-text-primary leading-relaxed">${meta.classification}</p>
                        <div class="flex items-center text-xs text-gray-500 mt-3 space-x-3">
                            <span>直接子类: ${meta.children || 0}</span>
                            <span>含下级: ${meta.descendants || 0}</span>
                        </div>
                    </div>
                    <div class="bg-white shadow-card rounded-lg p-4 border border-gray-100">
                        <div class="text-xs font-semibold text-teal-600 uppercase tracking-wide mb-1">导航路径</div>
                        <p class="text-sm text-text-primary leading-relaxed">${pathText}</p>
                    </div>
                `;
            }

            // 模拟FAQ数据存储
            let faqData = [
                { id: 'faq1', question: '产假多少天？', answer: '根据国家规定，女职工享受98天产假，其中产前可以休假15天', relatedDocs: ['2025年产假政策'], status: 'published', createdAt: '2025-12-01' },
                { id: 'faq2', question: '陪产假怎么申请？', answer: '陪产假申请流程：1. 填写《陪产假申请表》 2. 提交配偶生育证明 3. 部门审批', relatedDocs: ['2025年产假政策'], status: 'published', createdAt: '2025-12-02' },
                { id: 'faq3', question: '新员工入职需要什么材料？', answer: '需要准备：身份证原件及复印件、学历证书、离职证明、银行卡、一寸照片2张', relatedDocs: ['新员工入职指南'], status: 'published', createdAt: '2025-11-28' },
                { id: 'faq4', question: '如何办理社保转移？', answer: '社保转移需要到原单位开具参保证明，然后到新单位所在地社保局办理转入手续', relatedDocs: [], status: 'draft', createdAt: '2025-12-03' },
            ];

            // 知识体系增删改查功能
            window.addCategory = function() {
                const categoryName = prompt('请输入新分类名称：');
                if (!categoryName || !categoryName.trim()) return;

                const newId = 'category-' + Date.now();
                const newCategory = {
                    id: newId,
                    name: categoryName.trim(),
                    icon: 'folder',
                    color: 'blue',
                    children: []
                };
                knowledgeCategories.push(newCategory);
                expandedNodes.add(newId);

                // 选中新分类，便于继续维护
                selectKnowledgeTreeNode(newId, newCategory.name);
                alert(`分类"${categoryName}"添加成功！`);
            };

            // 添加子分类功能
            window.addChildCategory = function(parentId) {
                const categoryName = prompt('请输入子分类名称：');
                if (!categoryName || !categoryName.trim()) return;

                const newCategory = {
                    id: 'category-' + Date.now(),
                    name: categoryName.trim(),
                    icon: 'folder',
                    color: 'blue',
                    children: []
                };

                // 递归查找父节点并添加子节点
                function addToParent(categories) {
                    for (let cat of categories) {
                        if (cat.id === parentId) {
                            cat.children.push(newCategory);
                            return true;
                        }
                        if (cat.children && cat.children.length > 0) {
                            if (addToParent(cat.children)) return true;
                        }
                    }
                    return false;
                }

                if (addToParent(knowledgeCategories)) {
                    expandedNodes.add(parentId);
                    selectKnowledgeTreeNode(newCategory.id, newCategory.name);
                    alert(`子分类"${categoryName}"添加成功！`);
                }
            };

            window.editCategory = function(categoryId, currentName) {
                const newName = prompt('请输入新的分类名称：', currentName);
                if (!newName || !newName.trim() || newName === currentName) return;

                // 递归查找并更新分类
                function findAndUpdate(categories) {
                    for (let cat of categories) {
                        if (cat.id === categoryId) {
                            cat.name = newName.trim();
                            return true;
                        }
                        if (cat.children && cat.children.length > 0) {
                            if (findAndUpdate(cat.children)) return true;
                        }
                    }
                    return false;
                }

                if (findAndUpdate(knowledgeCategories)) {
                    selectKnowledgeTreeNode(categoryId, newName.trim());
                    alert(`分类名称已更新为"${newName}"`);
                }
            };

            window.deleteCategory = function(categoryId, categoryName) {
                if (!confirm(`确定要删除分类"${categoryName}"及其所有子分类吗？\n此操作不可恢复。`)) return;

                // 递归删除节点
                let removedIds = [];
                function removeFromTree(categories) {
                    for (let i = 0; i < categories.length; i++) {
                        const cat = categories[i];
                        if (cat.id === categoryId) {
                            removedIds = collectCategoryIds(cat, []);
                            categories.splice(i, 1);
                            return true;
                        }
                        if (cat.children && cat.children.length > 0) {
                            if (removeFromTree(cat.children)) return true;
                        }
                    }
                    return false;
                }

                if (removeFromTree(knowledgeCategories)) {
                    removedIds.forEach(id => expandedNodes.delete(id));

                    const removedActive = removedIds.includes(activeKnowledgeNodeId);
                    const fallbackId = removedActive ? 'all' : activeKnowledgeNodeId;
                    const fallbackName = fallbackId === 'all'
                        ? '全部知识'
                        : (findCategoryNode(knowledgeCategories, fallbackId)?.node?.name || '全部知识');

                    selectKnowledgeTreeNode(fallbackId, fallbackName);
                    alert(`分类"${categoryName}"及其子分类已删除`);
                }
            };

            // 渲染知识体系树 (递归实现支持多层级)
            function renderKnowledgeTree() {
                const treeContainer = document.getElementById('knowledge-tree-nodes');
                if (!treeContainer) return;

                const totalCategories = countCategories(knowledgeCategories);
                let html = `
                    <div class="tree-node" data-node-id="all">
                        <div class="tree-node-item px-3 py-2 rounded cursor-pointer hover:bg-gray-100 ${activeKnowledgeNodeId === 'all' ? 'active' : ''}" onclick="window.selectKnowledgeTreeNode && selectKnowledgeTreeNode('all', '全部知识')">
                            <i class="fa fa-home text-teal-600 mr-2"></i>
                            <span class="text-sm font-medium">全部知识</span>
                            <span class="ml-auto text-xs text-gray-500">${totalCategories}</span>
                        </div>
                    </div>
                `;

                html += renderCategoryNode(knowledgeCategories, 0);
                treeContainer.innerHTML = html;
            }

            // 递归渲染分类节点
            function renderCategoryNode(categories, level) {
                let html = '';
                const indent = level * 16; // 每层缩进16px

                categories.forEach(category => {
                    const hasChildren = category.children && category.children.length > 0;
                    const isExpanded = expandedNodes.has(category.id);
                    const isActive = category.id === activeKnowledgeNodeId;
                    const descendantCount = countCategories(category.children || []);

                    html += `
                        <div class="tree-node" data-node-id="${category.id}" style="padding-left: ${indent}px">
                            <div class="tree-node-item px-3 py-2 rounded cursor-pointer hover:bg-gray-100 flex items-center group ${isActive ? 'active' : ''}">
                                ${hasChildren ? `
                                    <i class="fa fa-caret-right tree-toggle mr-1 text-gray-500 ${isExpanded ? 'expanded' : ''}"
                                       onclick="toggleKnowledgeTreeNode('${category.id}'); event.stopPropagation();"></i>
                                ` : `<span class="w-3 mr-1"></span>`}
                                <i class="fa fa-${category.icon} text-${category.color}-500 mr-2"></i>
                                <span class="text-sm flex-1"
                                      onclick="selectKnowledgeTreeNode('${category.id}', '${category.name}')">${category.name}</span>
                                <span class="text-xs text-gray-500 mr-2">${descendantCount}</span>

                                <!-- 操作按钮 -->
                                <div class="hidden group-hover:flex space-x-1">
                                    <button class="text-green-500 hover:text-green-700 text-xs"
                                            onclick="addChildCategory('${category.id}'); event.stopPropagation();"
                                            title="添加子分类">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                    <button class="text-blue-500 hover:text-blue-700 text-xs"
                                            onclick="editCategory('${category.id}', '${category.name}'); event.stopPropagation();"
                                            title="编辑">
                                        <i class="fa fa-edit"></i>
                                    </button>
                                    <button class="text-red-500 hover:text-red-700 text-xs"
                                            onclick="deleteCategory('${category.id}', '${category.name}'); event.stopPropagation();"
                                            title="删除">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            ${hasChildren ? `
                                <div class="tree-children ${isExpanded ? '' : 'hidden'}">
                                    ${renderCategoryNode(category.children, level + 1)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                return html;
            }

            // 默认展开一级分类
            knowledgeCategories.forEach(cat => expandedNodes.add(cat.id));
            renderKnowledgeTree();
            renderNodeMeta('all', '全部知识');
            updateKnowledgeContent('all', '全部知识');

            // 添加分类按钮事件
            const addCategoryBtn = document.getElementById('add-category-btn');
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener('click', () => {
                    addCategory();
                });
            }

            // FAQ增删改查功能
            function loadFaqList() {
                const faqList = document.getElementById('faq-list');
                if (!faqList) return;

                if (faqData.length === 0) {
                    faqList.innerHTML = `
                        <div class="text-center text-text-secondary py-8">
                            <i class="fa fa-question-circle-o text-4xl mb-3"></i>
                            <p>暂无FAQ，点击右上角添加</p>
                        </div>
                    `;
                    return;
                }

                const html = faqData.map(faq => {
                    const statusColor = faq.status === 'published' ? 'green' : 'yellow';
                    const statusText = faq.status === 'published' ? '已发布' : '草稿';
                    const relatedDocsText = faq.relatedDocs.length > 0 ? faq.relatedDocs.join(', ') : '--';

                    return `
                        <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <i class="fa fa-question-circle text-teal-600 mr-2"></i>
                                        <h4 class="font-semibold text-text-primary">${faq.question}</h4>
                                        <span class="ml-2 px-2 py-0.5 bg-${statusColor}-100 text-${statusColor}-800 text-xs rounded-full">${statusText}</span>
                                    </div>
                                    <p class="text-sm text-text-secondary pl-6">${faq.answer}</p>
                                </div>
                            </div>
                            <div class="pl-6 border-t pt-3 mt-3">
                                <div class="flex items-center justify-between text-xs text-text-secondary">
                                    <div class="space-y-1">
                                        <div><i class="fa fa-link mr-1"></i>关联文档: ${relatedDocsText}</div>
                                        <div><i class="fa fa-clock-o mr-1"></i>创建时间: ${faq.createdAt}</div>
                                    </div>
                                    <div class="space-x-2">
                                        <button class="text-primary hover:text-secondary" onclick="window.viewFaq && viewFaq('${faq.id}')"><i class="fa fa-eye"></i> 查看</button>
                                        <button class="text-blue-500 hover:text-blue-700" onclick="window.editFaq && editFaq('${faq.id}')"><i class="fa fa-edit"></i> 编辑</button>
                                        <button class="text-red-500 hover:text-red-700" onclick="window.deleteFaq && deleteFaq('${faq.id}', '${faq.question}')"><i class="fa fa-trash"></i> 删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                faqList.innerHTML = html;
            }

            window.addFaq = function() {
                const question = prompt('请输入FAQ问题：');
                if (!question || !question.trim()) return;

                const answer = prompt('请输入FAQ答案：');
                if (!answer || !answer.trim()) return;

                const newFaq = {
                    id: 'faq-' + Date.now(),
                    question: question.trim(),
                    answer: answer.trim(),
                    relatedDocs: [],
                    status: 'draft',
                    createdAt: new Date().toISOString().split('T')[0]
                };

                faqData.push(newFaq);
                loadFaqList();
                alert('FAQ添加成功！');
            };

            window.editFaq = function(faqId) {
                const faq = faqData.find(f => f.id === faqId);
                if (!faq) return;

                const newQuestion = prompt('请输入新的问题：', faq.question);
                if (!newQuestion || !newQuestion.trim()) return;

                const newAnswer = prompt('请输入新的答案：', faq.answer);
                if (!newAnswer || !newAnswer.trim()) return;

                faq.question = newQuestion.trim();
                faq.answer = newAnswer.trim();
                loadFaqList();
                alert('FAQ更新成功！');
            };

            window.deleteFaq = function(faqId, question) {
                if (!confirm(`确定要删除FAQ"${question}"吗？\n此操作不可恢复。`)) return;

                faqData = faqData.filter(f => f.id !== faqId);
                loadFaqList();
                alert('FAQ已删除');
            };

            window.viewFaq = function(faqId) {
                const faq = faqData.find(f => f.id === faqId);
                if (!faq) return;

                const relatedDocsText = faq.relatedDocs.length > 0 ? faq.relatedDocs.join(', ') : '无';
                alert(`FAQ详情\n\n问题：${faq.question}\n\n答案：${faq.answer}\n\n关联文档：${relatedDocsText}\n\n状态：${faq.status === 'published' ? '已发布' : '草稿'}\n\n创建时间：${faq.createdAt}`);
            };

            // 添加FAQ按钮事件
            const addFaqBtn = document.getElementById('add-faq-btn');
            if (addFaqBtn) {
                addFaqBtn.addEventListener('click', () => {
                    addFaq();
                });
            }

            // ========== 文档上传弹窗管理 ==========
            let modalSelectedFiles = [];

            // 打开文档上传弹窗
            function openDocumentModal() {
                const modal = document.getElementById('add-document-modal');
                const categorySelect = document.getElementById('doc-category-select');

                // 动态生成分类选项
                categorySelect.innerHTML = '<option value="">请选择...</option>';
                function addCategoryOptions(categories, prefix = '') {
                    categories.forEach(cat => {
                        categorySelect.innerHTML += `<option value="${cat.id}">${prefix}${cat.name}</option>`;
                        if (cat.children && cat.children.length > 0) {
                            addCategoryOptions(cat.children, prefix + '　');
                        }
                    });
                }
                addCategoryOptions(knowledgeCategories);

                modal.classList.remove('hidden');
            }

            // 关闭弹窗
            function closeDocumentModal() {
                document.getElementById('add-document-modal').classList.add('hidden');
                // 清空表单
                document.getElementById('modal-file-list').innerHTML = '';
                modalSelectedFiles = [];
                document.getElementById('process-summary').checked = true;
                document.getElementById('process-tags').checked = true;
                document.getElementById('process-faq').checked = false;
                document.getElementById('faq-generalization-options').classList.add('hidden');
                document.getElementById('enable-faq-generalization').checked = false;
                document.getElementById('faq-gen-count-setting').classList.add('hidden');
            }

            // 绑定弹窗按钮事件
            document.getElementById('close-document-modal')?.addEventListener('click', closeDocumentModal);
            document.getElementById('cancel-document-btn')?.addEventListener('click', closeDocumentModal);

            // 文件拖拽上传
            const dropZone = document.getElementById('file-drop-zone');
            const modalFileInput = document.getElementById('modal-file-input');

            dropZone?.addEventListener('click', () => modalFileInput?.click());

            dropZone?.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-teal-500', 'bg-teal-50');
            });

            dropZone?.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-teal-500', 'bg-teal-50');
            });

            dropZone?.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-teal-500', 'bg-teal-50');
                handleModalFiles(e.dataTransfer.files);
            });

            modalFileInput?.addEventListener('change', (e) => {
                handleModalFiles(e.target.files);
            });

            function handleModalFiles(files) {
                Array.from(files).forEach(file => {
                    if (!modalSelectedFiles.find(f => f.name === file.name)) {
                        modalSelectedFiles.push(file);
                    }
                });
                renderModalFileList();
            }

            function renderModalFileList() {
                const fileList = document.getElementById('modal-file-list');
                if (modalSelectedFiles.length === 0) {
                    fileList.innerHTML = '';
                    return;
                }

                fileList.innerHTML = modalSelectedFiles.map((file, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center flex-1">
                            <i class="fa fa-file-o text-blue-500 mr-3"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-text-primary">${file.name}</p>
                                <p class="text-xs text-text-secondary">${(file.size / 1024).toFixed(2)} KB</p>
                            </div>
                        </div>
                        <button onclick="removeModalFile(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            window.removeModalFile = function(index) {
                modalSelectedFiles.splice(index, 1);
                renderModalFileList();
            };

            // FAQ泛化选项联动
            document.getElementById('process-faq')?.addEventListener('change', function() {
                const faqOptions = document.getElementById('faq-generalization-options');
                if (this.checked) {
                    faqOptions.classList.remove('hidden');
                } else {
                    faqOptions.classList.add('hidden');
                    document.getElementById('enable-faq-generalization').checked = false;
                    document.getElementById('faq-gen-count-setting').classList.add('hidden');
                }
            });

            // FAQ泛化复选框变化
            document.getElementById('enable-faq-generalization')?.addEventListener('change', function() {
                const countSetting = document.getElementById('faq-gen-count-setting');
                if (this.checked) {
                    countSetting.classList.remove('hidden');
                } else {
                    countSetting.classList.add('hidden');
                }
            });

            // 滑块值更新
            const faqSlider = document.getElementById('faq-gen-count-slider');
            const faqValueDisplay = document.getElementById('faq-gen-count-value');
            const faqTextDisplay = document.getElementById('faq-gen-count-text');

            faqSlider?.addEventListener('input', function() {
                faqValueDisplay.textContent = this.value;
                faqTextDisplay.textContent = this.value;
            });

            // 表单提交
            document.getElementById('confirm-document-btn')?.addEventListener('click', function() {
                const category = document.getElementById('doc-category-select').value;
                const processSummary = document.getElementById('process-summary').checked;
                const processTags = document.getElementById('process-tags').checked;
                const processFaq = document.getElementById('process-faq').checked;
                const enableFaqGen = document.getElementById('enable-faq-generalization').checked;
                const faqGenCount = document.getElementById('faq-gen-count-slider').value;

                // 验证
                if (!category) {
                    alert('请选择知识分类');
                    return;
                }
                if (modalSelectedFiles.length === 0) {
                    alert('请至少上传一个文件');
                    return;
                }

                // 构建配置对象
                const config = {
                    category,
                    files: modalSelectedFiles,
                    processing: {
                        summary: processSummary,
                        tags: processTags,
                        faq: processFaq,
                        faqGeneralization: processFaq && enableFaqGen ? {
                            enabled: true,
                            count: parseInt(faqGenCount)
                        } : { enabled: false }
                    }
                };

                console.log('文档上传配置：', config);
                alert(`已提交 ${modalSelectedFiles.length} 个文件进行处理\n\n配置信息：\n- 分类：${category}\n- 摘要生成：${processSummary ? '是' : '否'}\n- 标签映射：${processTags ? '是' : '否'}\n- FAQ挖掘：${processFaq ? '是' : '否'}${enableFaqGen ? `\n- FAQ泛化数量：${faqGenCount}个` : ''}`);

                closeDocumentModal();
                // TODO: 实际API调用
            });

            // 文档增删改查功能
            window.addDocument = function() {
                openDocumentModal();
            };

            window.viewDocument = function(docId) {
                alert('查看文档功能待实现\nDocument ID: ' + docId);
            };

            window.editDocument = function(docId) {
                alert('编辑文档功能待实现\nDocument ID: ' + docId);
            };

            window.deleteDocument = function(docId, title) {
                if (!confirm(`确定要删除文档"${title}"吗？\n此操作不可恢复。`)) return;
                alert('文档删除功能待实现');
            };

            // 添加文档按钮事件
            const addDocumentBtn = document.getElementById('add-document-btn');
            if (addDocumentBtn) {
                addDocumentBtn.addEventListener('click', () => {
                    addDocument();
                });
            }

            // 树节点展开/折叠功能
            window.toggleKnowledgeTreeNode = function(nodeId) {
                if (expandedNodes.has(nodeId)) {
                    expandedNodes.delete(nodeId);
                } else {
                    expandedNodes.add(nodeId);
                }
                renderKnowledgeTree();
            };

            // 树节点选中功能
            window.selectKnowledgeTreeNode = function(nodeId, nodeName) {
                activeKnowledgeNodeId = nodeId;
                if (nodeId !== 'all') {
                    ensureAncestorsExpanded(nodeId);
                }
                renderKnowledgeTree();

                // 更新面包屑
                const breadcrumbText = document.getElementById('breadcrumb-text');
                if (breadcrumbText) {
                    const pathNames = getNodePathNames(nodeId, nodeName);
                    breadcrumbText.textContent = pathNames.join(' / ');
                }

                renderNodeMeta(nodeId, nodeName);

                // 更新右侧内容（这里可以扩展为实际的数据加载）
                updateKnowledgeContent(nodeId, nodeName);
            };

            // 更新知识内容
            function updateKnowledgeContent(nodeId, nodeName) {
                const documentsList = document.getElementById('documents-list');
                const faqList = document.getElementById('faq-list');

                // 模拟文档数据
                const mockDocuments = {
                    'all': [
                        { id: 'doc-policy', title: 'HR政策手册 V1.0', desc: '战略与制度分类模型、角色职责与发布口径', date: '2025-12-01', status: 'active' },
                        { id: 'doc-onboarding', title: '入职准备清单（标准版）', desc: '入职前材料、设备/账号开通与首日迎新指引', date: '2025-11-15', status: 'active' },
                        { id: 'doc-payroll', title: '月度薪资核算SOP', desc: '薪资校验点、发薪SLA、个税与社保申报检查', date: '2025-11-30', status: 'active' },
                        { id: 'doc-knowledge', title: '知识运营治理指引', desc: '分类治理、责任人矩阵与版本变更流程', date: '2025-12-05', status: 'active' },
                    ],
                    'talent-onboarding': [
                        { id: 'doc-onboarding', title: '入职准备清单（标准版）', desc: '入职材料、设备与账号开通、报到节奏', date: '2025-11-15', status: 'active' },
                        { id: 'doc-probation', title: '试用期目标与转正模板', desc: '试用期OKR模板、辅导节奏与预警提示', date: '2025-12-02', status: 'active' },
                    ],
                    'operation-attendance': [
                        { id: 'doc-leave', title: '假期与加班调休政策', desc: '假期口径、额度、审批链与加班调休规则', date: '2025-12-03', status: 'active' },
                        { id: 'doc-attendance', title: '考勤异常处理SOP', desc: '漏打卡、异常工时的举证材料与纠错流程', date: '2025-11-25', status: 'active' },
                    ],
                    'reward-payroll': [
                        { id: 'doc-payroll', title: '月度薪资核算SOP', desc: '核算输入、三道校验、发薪与复核', date: '2025-11-30', status: 'active' },
                        { id: 'doc-tax', title: '个税与社保申报操作手册', desc: '申报周期、基数口径与异常处理节点', date: '2025-12-04', status: 'active' },
                    ],
                    'performance-management': [
                        { id: 'doc-performance', title: '绩效周期方案 2025H1', desc: '目标对齐时间表、评估与校准会操作步骤', date: '2025-12-06', status: 'active' },
                    ],
                    'offboarding-process': [
                        { id: 'doc-offboarding', title: '离职办理作业标准', desc: '主动/被动离职审批、补偿口径与留痕清单', date: '2025-12-01', status: 'active' },
                    ],
                    'knowledge-governance': [
                        { id: 'doc-taxonomy', title: '知识分类模型 V1.0', desc: '节点命名规范、版本演进与变更审批流', date: '2025-12-05', status: 'active' },
                    ],
                    'policy-compliance': [
                        { id: 'doc-compliance', title: '劳动合规检查清单', desc: '区域差异、标准合同要素与审计证据点', date: '2025-12-02', status: 'active' },
                    ]
                };

                const docs = mockDocuments[nodeId] || [];

                if (docs.length > 0) {
                    documentsList.innerHTML = docs.map(doc => `
                        <div class="bg-white rounded-lg shadow-card p-4 card-hover">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-file-text text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-text-primary">${doc.title}</h4>
                                        <p class="text-xs text-text-secondary mt-1">${doc.desc}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">活跃</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-text-secondary mt-3 pt-3 border-t">
                                <span><i class="fa fa-clock-o mr-1"></i>${doc.date}</span>
                                <div class="space-x-2">
                                    <button class="text-primary hover:text-secondary" onclick="window.viewDocument && viewDocument('${doc.id}')"><i class="fa fa-eye"></i> 查看</button>
                                    <button class="text-blue-500 hover:text-blue-700" onclick="window.editDocument && editDocument('${doc.id}')"><i class="fa fa-edit"></i> 编辑</button>
                                    <button class="text-red-500 hover:text-red-700" onclick="window.deleteDocument && deleteDocument('${doc.id}', '${doc.title}')"><i class="fa fa-trash"></i> 删除</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    documentsList.innerHTML = `
                        <div class="text-center text-text-secondary py-8">
                            <i class="fa fa-folder-open-o text-4xl mb-3"></i>
                            <p>该分类下暂无文档</p>
                        </div>
                    `;
                }
            }

            // 可拖动分隔条功能
            const knowledgeDivider = document.getElementById('knowledge-divider');
            const knowledgeTreeSide = document.getElementById('knowledge-tree-side');

            if (knowledgeDivider && knowledgeTreeSide) {
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                knowledgeDivider.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = knowledgeTreeSide.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const delta = e.clientX - startX;
                    let newWidth = startWidth + delta;

                    // 限制宽度范围 200px - 600px
                    newWidth = Math.max(200, Math.min(600, newWidth));

                    knowledgeTreeSide.style.width = `${newWidth}px`;
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';

                        // 保存宽度到localStorage
                        const width = knowledgeTreeSide.offsetWidth;
                        localStorage.setItem('knowledge-tree-width', width);
                    }
                });

                // 双击重置宽度
                knowledgeDivider.addEventListener('dblclick', () => {
                    knowledgeTreeSide.style.width = '256px';
                    localStorage.setItem('knowledge-tree-width', '256');
                });

                // 从localStorage恢复宽度
                const savedWidth = localStorage.getItem('knowledge-tree-width');
                if (savedWidth) {
                    knowledgeTreeSide.style.width = `${savedWidth}px`;
                }
            }

            // 标签页切换功能（已有的逻辑保持不变）
            // ...

            // ========== 完成！==========
            console.log('%c✅ 知识管理对话式交互系统已加载完成', 'color: #10b981; font-size: 14px; font-weight: bold;');
            console.log('%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'color: #6b7280;');
            console.log('%c🎯 可用的测试函数:', 'color: #1677FF; font-weight: bold;');
            console.log('   - showDocumentUploadDemo() : 模拟文档上传流程');
            console.log('   - showSimilarDocDemo() : 显示相似文档处理');
            console.log('   - showCategoryDemo() : 显示分类确认');
            console.log('   - showFaqDemo() : 显示FAQ审核');
            console.log('   - showExceptionPanelDemo() : 打开异常管理面板');
            console.log('%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'color: #6b7280;');
            console.log('%c💡 提示: 如果功能不正常，请按 Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Win) 强制刷新', 'color: #f59e0b;');
        });
    </script>
</body>

</html>
